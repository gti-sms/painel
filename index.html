<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Sa√∫de - Passo Fundo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>

    <style>
        :root {
            --primary: #0f62fe;
            --primary-dark: #0043ce;
            --accent: #00e676;
            --accent-dim: rgba(0,230,118,0.15);
            --danger: #ff4444;
            --warning: #ff9f00;
            --surface-0: #0a0f1e;
            --surface-1: #111827;
            --surface-2: #1a2235;
            --surface-3: #222d42;
            --border: rgba(255,255,255,0.08);
            --text-1: #f0f4ff;
            --text-2: #8b9abf;
            --text-3: #5a6a8a;
            --admin-bg: #f0f2f7;
            --admin-card: #ffffff;
            --admin-border: #e2e8f0;
            --admin-text: #1e293b;
            --admin-text-2: #64748b;
            --admin-primary: #0f62fe;
            --admin-sidebar: #1a2235;
            --font: 'Sora', sans-serif;
            --mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: var(--font); }
        
        html, body { width: 1920px; height: 1080px; overflow: hidden; position: fixed; top: 0; left: 0; }
        
        body { background: var(--surface-0); color: var(--text-1); }

        /* ‚îÄ‚îÄ‚îÄ DISPLAY ‚îÄ‚îÄ‚îÄ */
        .footer-line { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 3px; 
            background: linear-gradient(90deg, transparent 0%, var(--accent) 30%, #00bfff 70%, transparent 100%); 
            z-index: 100; 
        }
        
        .admin-gear { 
            position: fixed; top: 14px; right: 14px; width: 34px; height: 34px; 
            display: flex; align-items: center; justify-content: center; 
            cursor: pointer; z-index: 2000; opacity: 0.1; transition: opacity 0.4s; 
        }
        .admin-gear:hover { opacity: 0.7; }
        .admin-gear i { color: white; font-size: 18px; }

        .main-header { 
            background: linear-gradient(90deg, #0a1628 0%, #0d1f3c 100%);
            padding: 0 32px; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid rgba(0,230,118,0.25); 
            height: 72px; width: 100%; position: fixed; top: 0; left: 0; z-index: 100; 
        }
        .main-header::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent) 30%, #00bfff 70%, transparent);
        }
        
        .header-brand { display: flex; align-items: center; gap: 16px; }
        .header-brand .logo-dot { 
            width: 10px; height: 10px; border-radius: 50%; background: var(--accent); 
            box-shadow: 0 0 12px var(--accent);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
        
        .header-text h1 { font-size: 32px; font-weight: 700; letter-spacing: -0.3px; color: white; }
        #headerSubtitle { font-size: 20px; color: var(--text-2); font-weight: 400; margin-top: 2px; }
        
        .datetime-container { display: flex; flex-direction: column; align-items: flex-end; }
        #currentDate { font-size: 18px; color: var(--text-2); margin-bottom: 2px; }
        #currentTime { font-size: 52px; font-weight: 800; color: var(--accent); font-family: var(--mono); line-height: 1; }

        .main-container { 
            position: fixed; top: 72px; left: 0; width: 100%; 
            height: calc(100% - 76px); 
            display: grid; grid-template-columns: 75% 25%; gap: 10px; padding: 10px; 
        }

        .left-column { display: flex; flex-direction: column; gap: 8px; }

        .video-section { 
            background: #000; border-radius: 12px; overflow: hidden; flex: 4; 
            border: 1px solid var(--border); position: relative; 
        }
        .video-container { width: 100%; height: 100%; }
        .video-iframe { width: 100%; height: 100%; border: none; }

        .btn-som { 
            position: absolute; bottom: 16px; left: 16px; z-index: 101; 
            background: rgba(0,230,118,0.9); color: #000; border: none; 
            padding: 10px 20px; border-radius: 24px; cursor: pointer; 
            font-weight: 700; font-size: 13px; font-family: var(--font);
            display: flex; align-items: center; gap: 8px;
        }

        .announcements-section { 
            background: rgba(15,98,254,0.08); border-radius: 12px; padding: 0; 
            height: 100px; border: 1px solid rgba(15,98,254,0.2); 
            position: relative; overflow: hidden; 
        }
        .ticker-item { 
            position: absolute; width: 100%; height: 100%; 
            display: flex; align-items: center; font-size: 30px; font-weight: 600; 
            opacity: 0; padding: 0 24px; 
            border-left: 4px solid var(--primary);
            color: var(--text-1);
        }
        .ticker-item.active { animation: slideInOut 30s ease-in-out forwards; }
        @keyframes slideInOut { 
            0%{transform:translateX(100%);opacity:0} 
            5%{transform:translateX(0);opacity:1} 
            95%{transform:translateX(0);opacity:1} 
            100%{transform:translateX(-100%);opacity:0} 
        }

        .right-column { 
            background: var(--surface-1); border-radius: 12px; padding: 14px; 
            border: 1px solid var(--border); overflow: hidden; 
        }
        .carousel-container { height: 100%; position: relative; }
        .carousel-item { 
            position: absolute; width: 100%; height: 100%; opacity: 0; 
            display: flex; flex-direction: column; transition: opacity 0.6s ease-in-out; 
        }
        .carousel-item.active { opacity: 1; }

        .section-title { 
            font-size: 20px; font-weight: 800; color: white; 
            text-align: center; margin-bottom: 12px; text-transform: uppercase; 
            letter-spacing: 2px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .total-container { 
            border-radius: 10px; padding: 14px; text-align: center; 
            margin-bottom: 12px; background: var(--surface-2);
            border: 1px solid var(--border);
        }
        .total-container.red-bg { background: linear-gradient(135deg, rgba(255,68,68,0.2), rgba(255,68,68,0.08)); border-color: rgba(255,68,68,0.3); }
        .total-container.blue-bg { background: linear-gradient(135deg, rgba(15,98,254,0.2), rgba(15,98,254,0.08)); border-color: rgba(15,98,254,0.3); }
        .total-container.purple-bg { background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(139,92,246,0.08)); border-color: rgba(139,92,246,0.3); }

        .total-value { font-size: 56px; font-weight: 800; font-family: var(--mono); color: white; margin-top: 4px; }
        .total-label { font-size: 15px; color: var(--text-2); text-transform: uppercase; letter-spacing: 1px; }
        .total-label-warn {
            font-size: 16px; color: white; font-weight: 700;
            letter-spacing: 0.5px; text-transform: uppercase;
            line-height: 1.4; padding: 0 4px;
        }

        .lista-container { flex: 1; display: flex; flex-direction: column; gap: 5px; overflow: hidden; padding: 2px 0; }
        .item-lista { 
            background: var(--surface-2); border-radius: 8px; padding: 8px 14px; 
            display: flex; justify-content: space-between; align-items: center; 
            flex: 1; min-height: 0; max-height: 60px;
            border: 1px solid var(--border);
        }
        .item-nome { font-size: 18px; font-weight: 500; color: var(--text-2); flex: 1; }
        .item-valor { font-size: 32px; font-weight: 800; font-family: var(--mono); margin-left: 12px; }
        .valor-red { color: #ff6b6b; }
        .valor-white { color: white; }

        /* ‚îÄ‚îÄ‚îÄ FLAYER CONTAINER ‚îÄ‚îÄ‚îÄ */
        #flayerContainer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; align-items: center; justify-content: center;
            background: #000; z-index: 50;
        }
        #flayerContainer img { width: 100%; height: 100%; object-fit: contain; }
        
        /* ‚îÄ‚îÄ‚îÄ COUNTDOWN BAR ‚îÄ‚îÄ‚îÄ */
        #countdownBar {
            position: absolute; bottom: 0; left: 0; height: 4px;
            background: var(--accent); z-index: 200;
            transition: width linear;
        }

        /* ‚îÄ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ‚îÄ */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--surface-0); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .loading-ring { 
            width: 56px; height: 56px; border: 3px solid var(--border); 
            border-radius: 50%; border-top-color: var(--accent); 
            animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 16px; color: var(--text-2); }

        /* ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ */
        #loginScreen { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);
            z-index: 3000; justify-content: center; align-items: center; 
        }
        .login-box {
            background: white; padding: 48px; border-radius: 20px; width: 440px; 
            text-align: center; box-shadow: 0 40px 80px rgba(0,0,0,0.4);
        }
        .login-icon-wrap { 
            width: 72px; height: 72px; border-radius: 50%; 
            background: linear-gradient(135deg, var(--admin-primary), #0043ce); 
            display: flex; align-items: center; justify-content: center; 
            margin: 0 auto 24px; 
        }
        .login-icon-wrap i { color: white; font-size: 28px; }
        .login-box h2 { color: var(--admin-text); font-size: 22px; font-weight: 700; margin-bottom: 6px; }
        .login-box p { color: var(--admin-text-2); font-size: 14px; margin-bottom: 28px; }
        .login-input {
            width: 100%; padding: 14px 16px; margin-bottom: 14px;
            border: 1.5px solid var(--admin-border); border-radius: 10px;
            font-size: 14px; font-family: var(--font); color: var(--admin-text);
            transition: border-color 0.2s, box-shadow 0.2s; background: #f8fafc;
        }
        .login-input:focus { 
            outline: none; border-color: var(--admin-primary); 
            box-shadow: 0 0 0 3px rgba(15,98,254,0.12); background: white;
        }
        .login-btn {
            width: 100%; padding: 14px; border: none; border-radius: 10px;
            background: var(--admin-primary); color: white; font-size: 15px; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            gap: 10px; font-family: var(--font); margin-top: 8px;
            transition: background 0.2s, transform 0.1s;
        }
        .login-btn:hover { background: var(--primary-dark); }
        .login-btn:active { transform: scale(0.98); }
        
        .user-info-box { 
            background: #f8fafc; border-radius: 12px; padding: 20px; 
            display: flex; gap: 16px; align-items: center; margin-bottom: 20px;
            border: 1px solid var(--admin-border);
        }
        .user-avatar-circle { 
            width: 52px; height: 52px; border-radius: 50%; 
            background: linear-gradient(135deg, #0f62fe, #0043ce);
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .user-avatar-circle i { color: white; font-size: 22px; }
        .user-details { text-align: left; }
        .user-name { font-size: 16px; font-weight: 700; color: var(--admin-text); margin-bottom: 6px; }
        .role-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 3px 10px; border-radius: 20px; font-size: 12px; font-weight: 600;
        }
        .role-super { background: #fff1f2; color: #be123c; }
        .role-admin { background: #eff6ff; color: #1d4ed8; }
        .role-viewer { background: #fff7ed; color: #c2410c; }
        .btn-secondary-login {
            width: 100%; padding: 12px; border: 1.5px solid var(--admin-border); 
            border-radius: 10px; background: transparent; color: var(--admin-text-2); 
            font-size: 14px; font-weight: 500; cursor: pointer; font-family: var(--font);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            margin-top: 10px; transition: all 0.2s;
        }
        .btn-secondary-login:hover { background: #f8fafc; border-color: #94a3b8; }

        /* ‚îÄ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ */
        #adminPanel { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 3000; flex-direction: column; 
            background: var(--admin-bg);
        }

        .admin-topbar {
            height: 60px; background: white; border-bottom: 1px solid var(--admin-border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 28px; flex-shrink: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .admin-topbar-left { display: flex; align-items: center; gap: 16px; }
        .admin-logo-badge {
            width: 34px; height: 34px; border-radius: 9px;
            background: linear-gradient(135deg, #0f62fe, #0043ce);
            display: flex; align-items: center; justify-content: center;
        }
        .admin-logo-badge i { color: white; font-size: 15px; }
        .admin-topbar h1 { font-size: 16px; font-weight: 700; color: var(--admin-text); }
        .admin-topbar-meta { font-size: 13px; color: var(--admin-text-2); margin-left: 16px; padding-left: 16px; border-left: 1px solid var(--admin-border); }
        .admin-topbar-right { display: flex; align-items: center; gap: 10px; }
        
        .tb-btn {
            height: 36px; padding: 0 16px; border: none; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer; font-family: var(--font);
            display: flex; align-items: center; gap: 8px; transition: all 0.2s;
        }
        .tb-btn-save { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .tb-btn-save:hover { background: #d1fae5; }
        .tb-btn-logout { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .tb-btn-logout:hover { background: #fee2e2; }

        .admin-body { display: grid; grid-template-columns: 220px 1fr; flex: 1; overflow: hidden; }

        /* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
        .admin-sidebar { 
            background: var(--admin-sidebar); overflow-y: auto; padding: 20px 0; 
            display: flex; flex-direction: column; gap: 2px;
        }
        .sidebar-group-label { 
            font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.25); 
            text-transform: uppercase; letter-spacing: 1.5px;
            padding: 16px 20px 8px;
        }
        .sidebar-item { 
            margin: 0 10px; padding: 10px 14px; border-radius: 8px;
            cursor: pointer; font-size: 13px; font-weight: 500; 
            color: rgba(255,255,255,0.55); transition: all 0.2s;
            display: flex; align-items: center; gap: 10px;
        }
        .sidebar-item i { font-size: 14px; width: 16px; text-align: center; }
        .sidebar-item:hover { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.9); }
        .sidebar-item.active { 
            background: rgba(15,98,254,0.25); color: #60a5fa; 
            border: 1px solid rgba(15,98,254,0.3);
        }
        .sidebar-item.active i { color: #60a5fa; }

        /* ‚îÄ‚îÄ‚îÄ ADMIN CONTENT ‚îÄ‚îÄ‚îÄ */
        .admin-content { 
            overflow-y: auto; padding: 32px 40px; 
            background: var(--admin-bg);
        }

        .page-header { margin-bottom: 28px; }
        .page-header h2 { font-size: 22px; font-weight: 700; color: var(--admin-text); margin-bottom: 6px; }
        .page-header p { font-size: 14px; color: var(--admin-text-2); }

        .card {
            background: var(--admin-card); border-radius: 14px; padding: 28px;
            border: 1px solid var(--admin-border); margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04);
        }
        .card h3 { 
            font-size: 14px; font-weight: 700; color: var(--admin-text); 
            margin-bottom: 20px; padding-bottom: 14px; 
            border-bottom: 1px solid var(--admin-border);
            display: flex; align-items: center; gap: 10px;
        }
        .card h3 .card-icon { 
            width: 28px; height: 28px; border-radius: 7px;
            background: #eff6ff; color: var(--admin-primary);
            display: flex; align-items: center; justify-content: center; font-size: 12px;
        }

        .info-banner {
            background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 10px;
            padding: 14px 18px; margin-bottom: 22px; font-size: 13px; color: #1e40af;
            display: flex; align-items: flex-start; gap: 10px;
        }
        .info-banner i { margin-top: 2px; flex-shrink: 0; }

        .form-label { font-size: 13px; font-weight: 600; color: var(--admin-text); margin-bottom: 8px; display: block; }
        .form-input {
            width: 100%; padding: 11px 14px; border: 1.5px solid var(--admin-border);
            border-radius: 9px; font-size: 14px; font-family: var(--font);
            color: var(--admin-text); background: #f8fafc; transition: all 0.2s;
        }
        .form-input:focus { outline: none; border-color: var(--admin-primary); box-shadow: 0 0 0 3px rgba(15,98,254,0.1); background: white; }
        textarea.form-input { min-height: 140px; resize: vertical; line-height: 1.6; }

        .btn {
            height: 40px; padding: 0 20px; border: none; border-radius: 9px;
            font-size: 13px; font-weight: 600; cursor: pointer; font-family: var(--font);
            display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s;
        }
        .btn-primary { background: var(--admin-primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-danger { background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .btn-danger:hover { background: #fee2e2; }
        .btn-ghost { background: var(--admin-bg); color: var(--admin-text-2); border: 1px solid var(--admin-border); }
        .btn-ghost:hover { background: #e2e8f0; }
        .btn-success { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        .btn-success:hover { background: #dcfce7; }

        .item-row {
            display: grid; grid-template-columns: 1fr 120px 44px;
            gap: 10px; align-items: center; margin-bottom: 10px;
            padding: 12px 16px; background: #f8fafc; border-radius: 10px;
            border: 1px solid var(--admin-border); transition: border-color 0.2s;
        }
        .item-row:hover { border-color: #94a3b8; }
        .item-row input { text-align: center; }
        .btn-icon {
            width: 36px; height: 36px; border: none; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 13px; transition: all 0.2s;
        }
        .btn-icon-remove { background: #fef2f2; color: #dc2626; }
        .btn-icon-remove:hover { background: #fee2e2; }

        /* TABLE */
        .data-table {
            width: 100%; border-collapse: collapse;
            background: white; border-radius: 12px; overflow: hidden;
            border: 1px solid var(--admin-border);
        }
        .data-table th {
            padding: 13px 18px; text-align: left; 
            background: #f8fafc; color: var(--admin-text-2);
            font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
            border-bottom: 1px solid var(--admin-border);
        }
        .data-table td { 
            padding: 14px 18px; color: var(--admin-text);
            border-bottom: 1px solid #f1f5f9; font-size: 14px;
        }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: #f8fafc; }
        .data-table code { 
            background: #f1f5f9; padding: 3px 8px; border-radius: 5px; 
            font-family: var(--mono); font-size: 12px; color: var(--admin-primary);
        }

        /* BADGES */
        .badge { 
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; 
        }
        .badge-green { background: #f0fdf4; color: #15803d; }
        .badge-red { background: #fef2f2; color: #dc2626; }
        .badge-blue { background: #eff6ff; color: #1d4ed8; }
        .badge-amber { background: #fffbeb; color: #b45309; }

        /* UNIT CARDS */
        .units-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 16px; }
        .unit-card {
            background: white; border-radius: 14px; padding: 22px;
            border: 1px solid var(--admin-border); transition: all 0.25s;
        }
        .unit-card:hover { transform: translateY(-3px); box-shadow: 0 12px 28px rgba(0,0,0,0.08); border-color: #94a3b8; }
        .unit-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .unit-card-name { font-size: 16px; font-weight: 700; color: var(--admin-text); margin-bottom: 4px; }
        .unit-card-id { font-size: 11px; color: var(--admin-text-2); font-family: var(--mono); }
        .unit-stats { display: flex; gap: 0; margin: 14px 0; border-radius: 10px; overflow: hidden; border: 1px solid var(--admin-border); }
        .unit-stat { flex: 1; padding: 12px; text-align: center; background: #f8fafc; border-right: 1px solid var(--admin-border); }
        .unit-stat:last-child { border-right: none; }
        .unit-stat-val { font-size: 20px; font-weight: 800; color: var(--admin-primary); font-family: var(--mono); }
        .unit-stat-lbl { font-size: 10px; color: var(--admin-text-2); text-transform: uppercase; letter-spacing: 0.5px; }
        .unit-actions { display: flex; gap: 8px; margin-top: 16px; }
        .unit-btn { 
            flex: 1; height: 36px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 12px; font-weight: 600; font-family: var(--font);
            display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.2s;
        }
        .unit-btn-primary { background: var(--admin-primary); color: white; }
        .unit-btn-primary:hover { background: var(--primary-dark); }
        .unit-btn-ghost { background: #f8fafc; color: var(--admin-text-2); border: 1px solid var(--admin-border); }
        .unit-btn-ghost:hover { background: #f1f5f9; }
        .unit-btn-danger { background: #fef2f2; color: #dc2626; }
        .unit-btn-danger:hover { background: #fee2e2; }

        /* STAT CARDS */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
        .stat-card {
            border-radius: 12px; padding: 20px; color: white; text-align: center;
        }
        .stat-card-val { font-size: 36px; font-weight: 800; font-family: var(--mono); }
        .stat-card-lbl { font-size: 12px; opacity: 0.85; margin-top: 4px; }

        /* FLAYER PREVIEW */
        .flayer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 14px; }
        .flayer-card {
            background: white; border-radius: 12px; overflow: hidden;
            border: 1px solid var(--admin-border); transition: all 0.2s;
        }
        .flayer-card:hover { border-color: #94a3b8; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .flayer-img-wrap { height: 120px; background: #f8fafc; display: flex; align-items: center; justify-content: center; }
        .flayer-img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .flayer-footer { padding: 10px 12px; border-top: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: space-between; }
        .flayer-num { font-size: 11px; font-weight: 700; background: var(--admin-primary); color: white; padding: 2px 8px; border-radius: 12px; }
        .flayer-del { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 16px; padding: 4px; }

        .upload-zone {
            border: 2px dashed #cbd5e1; border-radius: 12px; padding: 30px 20px;
            text-align: center; cursor: pointer; transition: all 0.2s;
            background: #f8fafc; margin-bottom: 20px;
        }
        .upload-zone:hover { border-color: var(--admin-primary); background: #eff6ff; }
        .upload-zone i { font-size: 32px; color: #94a3b8; margin-bottom: 10px; display: block; }
        .upload-zone p { font-size: 14px; color: var(--admin-text-2); }

        /* NOTIFICATION */
        .notif {
            position: fixed; top: 20px; right: 20px;
            padding: 14px 20px; border-radius: 12px; color: white;
            font-weight: 600; font-size: 14px; z-index: 9999;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            animation: slideInNotif 0.3s ease-out;
        }
        @keyframes slideInNotif { from{transform:translateX(120%);opacity:0} to{transform:translateX(0);opacity:1} }
        @keyframes slideOutNotif { from{transform:translateX(0);opacity:1} to{transform:translateX(120%);opacity:0} }
        .notif-success { background: linear-gradient(135deg, #059669, #10b981); }
        .notif-error { background: linear-gradient(135deg, #dc2626, #ef4444); }
        .notif-info { background: linear-gradient(135deg, #1d4ed8, #3b82f6); }
        .notif-warning { background: linear-gradient(135deg, #d97706, #f59e0b); }

        .version-badge {
            position: absolute; bottom: 10px; right: 20px;
            font-size: 11px; color: rgba(255,255,255,0.2);
        }

        @media (max-width: 1920px) { html, body { width: 100%; height: 100%; } }
    </style>
</head>
<body>

    <div id="loadingOverlay" class="loading-overlay" style="display:none;">
        <div class="loading-ring"></div>
        <div class="loading-text" id="loadingText">Carregando...</div>
    </div>

    <div class="footer-line"></div>
    <div class="admin-gear" onclick="openLogin()"><i class="fas fa-cog"></i></div>

    <header class="main-header">
        <div class="header-brand">
            <div class="logo-dot"></div>
            <div class="header-text">
                <h1 id="mainTitle">Secretaria Municipal de Sa√∫de</h1>
                <div id="headerSubtitle">Carregando...</div>
            </div>
        </div>
        <div class="datetime-container">
            <div id="currentDate"></div>
            <div id="currentTime"></div>
        </div>
    </header>

    <main class="main-container">
        <div class="left-column">
            <section class="video-section" id="videoSection">
                <button id="btnSom" class="btn-som" onclick="ativarSom()">
                    <i class="fas fa-volume-up"></i> Ativar Som
                </button>
                <div class="video-container" id="videoContainer"></div>
                <div id="flayerContainer"></div>
                <div id="countdownBar" style="width:0;display:none;"></div>
            </section>
            <section class="announcements-section" id="tickerContainer"></section>
        </div>
        <div class="right-column">
            <div class="carousel-container" id="carouselContainer">
                <div class="carousel-item active" id="itemFaltometro"></div>
                <div class="carousel-item" id="itemAtendimentos"></div>
                <div class="carousel-item" id="itemSMS"></div>
            </div>
        </div>
    </main>

    <!-- ‚îÄ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ‚îÄ -->
    <div id="loginScreen">
        <div class="login-box">
            <div class="login-icon-wrap"><i class="fas fa-shield-alt"></i></div>
            <h2 id="loginLabel">Acesso Administrativo</h2>
            <p id="loginDescription">Informe suas credenciais para continuar</p>
            
            <div id="loginMethods">
                <input type="text" id="loginUsuario" class="login-input" placeholder="Usu√°rio">
                <input type="password" id="loginSenha" class="login-input" placeholder="Senha" onkeydown="if(event.key==='Enter')verificarLogin()">
                <button class="login-btn" onclick="verificarLogin()">
                    <i class="fas fa-arrow-right"></i> Entrar
                </button>
                <button class="btn-secondary-login" onclick="fecharLogin()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
            </div>
            
            <div id="userInfo" style="display:none;">
                <div class="user-info-box">
                    <div class="user-avatar-circle"><i class="fas fa-user"></i></div>
                    <div class="user-details">
                        <div class="user-name" id="userName">‚Äî</div>
                        <span class="role-badge" id="userRole"></span>
                    </div>
                </div>
                <button class="login-btn" onclick="continuarParaPainel()">
                    <i class="fas fa-columns"></i> Acessar Painel
                </button>
                <button class="btn-secondary-login" onclick="trocarUsuario()">
                    <i class="fas fa-user-switch"></i> Trocar Usu√°rio
                </button>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ -->
    <div id="adminPanel">
        <div class="admin-topbar">
            <div class="admin-topbar-left">
                <div class="admin-logo-badge"><i class="fas fa-hospital-user"></i></div>
                <h1>Painel Administrativo</h1>
                <span class="admin-topbar-meta">
                    Unidade: <strong id="adminUnidadeNome">‚Äî</strong> &nbsp;¬∑&nbsp; Usu√°rio: <strong id="adminUserName">‚Äî</strong>
                </span>
            </div>
            <div class="admin-topbar-right">
                <button class="tb-btn tb-btn-save" onclick="salvarDados()"><i class="fas fa-save"></i> Salvar</button>
                <button class="tb-btn tb-btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </div>

        <div class="admin-body">
            <nav class="admin-sidebar" id="sidebar">
                <!-- Grupo: Minha Unidade (vis√≠vel para todos os admins) -->
                <div class="sidebar-group-label">Minha Unidade</div>
                <div class="sidebar-item active" onclick="mostrarSecao('unidade')"><i class="fas fa-hospital"></i> Identifica√ß√£o</div>
                <div class="sidebar-item" id="menuFalto" onclick="mostrarSecao('faltometro')"><i class="fas fa-calendar-times"></i> Falt√¥metro</div>
                <div class="sidebar-item" id="menuAtend" onclick="mostrarSecao('atendimentos')"><i class="fas fa-stethoscope"></i> Atendimentos</div>
                <div class="sidebar-item" id="menuAvisosUnidade" onclick="mostrarSecao('avisos_unidade')"><i class="fas fa-bell"></i> Meus Avisos</div>

                <!-- Grupo: Central (somente Matriz) -->
                <div class="sidebar-group-label" id="groupCentral" style="display:none;">Central</div>
                <div class="sidebar-item" id="menuAvisosCentral" style="display:none;" onclick="mostrarSecao('avisos_central')"><i class="fas fa-satellite-dish"></i> Avisos da Central</div>
                <div class="sidebar-item" id="menuFlayers" style="display:none;" onclick="mostrarSecao('flayers')"><i class="fas fa-images"></i> Flyers / Encartes</div>
                <div class="sidebar-item" id="menuVideo" style="display:none;" onclick="mostrarSecao('video')"><i class="fas fa-play-circle"></i> V√≠deos YouTube</div>
                <div class="sidebar-item" id="menuSMS" style="display:none;" onclick="mostrarSecao('sms')"><i class="fas fa-city"></i> Produ√ß√£o Municipal</div>

                <!-- Grupo: Administra√ß√£o (somente super_admin na Matriz) -->
                <div class="sidebar-group-label" id="groupAdmin" style="display:none;">Administra√ß√£o</div>
                <div class="sidebar-item" id="menuUsuarios" style="display:none;" onclick="mostrarSecao('usuarios')"><i class="fas fa-users-cog"></i> Usu√°rios</div>
                <div class="sidebar-item" id="menuUnidades" style="display:none;" onclick="mostrarSecao('unidades')"><i class="fas fa-building"></i> Unidades</div>
                <div class="sidebar-item" id="menuMonitor" style="display:none;" onclick="mostrarSecao('monitor')"><i class="fas fa-satellite-dish"></i> Monitor</div>
                <div class="sidebar-item" id="menuSincronizacao" style="display:none;" onclick="mostrarSecao('sincronizacao')"><i class="fas fa-sync-alt"></i> Sincroniza√ß√£o</div>
                <div class="sidebar-item" id="menuBackup" style="display:none;" onclick="mostrarSecao('backup')"><i class="fas fa-cloud-upload-alt"></i> Backup / Restore</div>
            </nav>
            <div class="admin-content" id="adminContent"></div>
        </div>
        <div class="version-badge">PMPF Sa√∫de v3.4 | Central ‚Üí Flyers/V√≠deos/SMS/AvisosCentral | Unidade ‚Üí Falt√¥metro/Atendimentos/MeusAvisos</div>
    </div>

    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // GLOBALS ‚Äî declarados primeiro, antes de tudo
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const urlParams   = new URLSearchParams(window.location.search);
    const unidadeID   = urlParams.get('id') || 'geral';
    const isMatriz    = (unidadeID === 'geral');

    // Credencial de emerg√™ncia ‚Äî funciona sem Firebase
    const ADMIN_EMERGENCIAL = { login:'gti', senha:'Itatilac2009', nome:'Administrador GTI', nivel:'super_admin', unidades_permitidas:['todas'], status:'ativo' };

    let dadosUnidade  = { unidade: { nome:'', especialidades:[], atendimentos:[] }, avisos:[], flayers:[] };
    let dadosGerais   = { unidade: { videoUrls:[], smsMunicipal:[] }, avisos:[], flayers:[] };
    let todasUnidades = {}; let listaUsuarios = []; let listaTodasUnidades = [];
    let usuarioAtual  = null; let permissoesUsuario = null;
    let isMuted       = true; let carouselIndex = 0; let tickerInterval = null;

    let playlist = []; let playIndex = 0; let playlistActive = false;
    let safetyTimer = null; let imageTimer = null; let countdownRaf = null;
    let youtubeMessageHandler = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FIREBASE ‚Äî iniciado ap√≥s globals
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const firebaseConfig = {
        apiKey: "AIzaSyCEyebuGCoD8NYQJrIR1KpRRpkWijveN3A",
        authDomain: "gti-painel.firebaseapp.com",
        databaseURL: "https://gti-painel-default-rtdb.firebaseio.com",
        projectId: "gti-painel",
        storageBucket: "gti-painel.firebasestorage.app",
        messagingSenderId: "805155882010",
        appId: "1:805155882010:web:6fed70ecffb8f07eb9fda3",
        measurementId: "G-0T1FWSRNLW"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    function buildPlaylist() {
        playlist = [];
        // V√≠deos da Central (aparecem em todas as unidades)
        (dadosGerais.unidade.videoUrls || []).forEach(url => {
            if (url && url.trim()) playlist.push({ type:'youtube', url:url.trim() });
        });
        // Flyers da Central (paineis/geral/flayers ‚Äî aparecem em todas as unidades)
        (dadosGerais.flayers || []).forEach(url => {
            if (url && url.trim()) playlist.push({ type:'image', url:url.trim() });
        });
        console.log(`üìã Playlist: ${playlist.length} itens (${playlist.filter(i=>i.type==='youtube').length} v√≠deos, ${playlist.filter(i=>i.type==='image').length} flyers)`);
    }

    function startPlaylist() {
        stopPlaylist();
        buildPlaylist();
        if (!playlist.length) { console.log('‚ö†Ô∏è Playlist vazia'); return; }
        playlistActive = true;
        playIndex = 0;
        playItem();
    }

    function stopPlaylist() {
        playlistActive = false;
        clearTimers();
        removeYTListener();
        const vc = document.getElementById('videoContainer');
        const fc = document.getElementById('flayerContainer');
        if (vc) vc.innerHTML = '';
        if (fc) { fc.style.display = 'none'; fc.innerHTML = ''; }
        hideCountdown();
    }

    function clearTimers() {
        if (safetyTimer) { clearTimeout(safetyTimer); safetyTimer = null; }
        if (imageTimer)  { clearTimeout(imageTimer);  imageTimer  = null; }
        if (countdownRaf){ cancelAnimationFrame(countdownRaf); countdownRaf = null; }
    }

    function removeYTListener() {
        if (youtubeMessageHandler) {
            window.removeEventListener('message', youtubeMessageHandler);
            youtubeMessageHandler = null;
        }
    }

    function nextItem() {
        if (!playlistActive) return;
        playIndex = (playIndex + 1) % playlist.length;
        console.log(`‚è≠ Item ${playIndex+1}/${playlist.length}`);
        playItem();
    }

    function playItem() {
        if (!playlistActive || !playlist.length) return;
        clearTimers();
        removeYTListener();

        const item = playlist[playIndex];
        const vc   = document.getElementById('videoContainer');
        const fc   = document.getElementById('flayerContainer');
        const btn  = document.getElementById('btnSom');

        console.log(`‚ñ∂Ô∏è Reproduzindo [${playIndex+1}/${playlist.length}] ${item.type}: ${item.url.substring(0,60)}`);

        if (item.type === 'youtube') {
            // ‚Äî mostrar container de v√≠deo ‚Äî
            if (vc) vc.style.display = 'block';
            if (fc) { fc.style.display = 'none'; fc.innerHTML = ''; }
            if (btn) btn.style.display = isMuted ? 'block' : 'none';
            hideCountdown();

            const vid = extractYTId(item.url);
            if (!vid) { console.error('‚ùå ID YT inv√°lido'); nextItem(); return; }

            const muted = isMuted ? 1 : 0;
            if (vc) vc.innerHTML = `<iframe id="ytIframe" class="video-iframe"
                src="https://www.youtube.com/embed/${vid}?autoplay=1&mute=${muted}&enablejsapi=1&origin=${encodeURIComponent(location.origin)}"
                allow="autoplay; encrypted-media; gyroscope" allowfullscreen></iframe>`;

            // Listener para detectar fim do v√≠deo
            youtubeMessageHandler = function(event) {
                try {
                    const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
                    // Estado 0 = ended
                    if (data && data.event === 'onStateChange' && data.info === 0) {
                        console.log('‚úÖ V√≠deo terminou ‚Üí pr√≥ximo');
                        clearTimers();
                        removeYTListener();
                        nextItem();
                    }
                } catch(e) {}
            };
            window.addEventListener('message', youtubeMessageHandler);

            // Timer de seguran√ßa: 10 minutos (caso n√£o detecte fim)
            safetyTimer = setTimeout(() => {
                console.log('‚è∞ Timeout seguran√ßa v√≠deo ‚Üí pr√≥ximo');
                removeYTListener();
                nextItem();
            }, 600000);

        } else if (item.type === 'image') {
            // ‚Äî mostrar flayer ‚Äî
            if (vc) vc.style.display = 'none';
            if (btn) btn.style.display = 'none';
            if (fc) {
                fc.style.display = 'flex';
                fc.innerHTML = `<img src="${item.url}" alt="flyer"
                    style="width:100%;height:100%;object-fit:contain;"
                    onload="onImageLoaded()"
                    onerror="onImageError()">`;
            }
        }
    }

    // Chamada quando a imagem carrega com sucesso
    function onImageLoaded() {
        console.log('üñºÔ∏è Imagem carregada ‚Üí 30s');
        clearTimers();
        startCountdown(30000);
        imageTimer = setTimeout(() => { console.log('‚è∞ Tempo da imagem ‚Üí pr√≥ximo'); nextItem(); }, 30000);
    }

    // Chamada quando a imagem falha
    function onImageError() {
        console.error('‚ùå Erro ao carregar imagem ‚Üí pr√≥ximo em 5s');
        clearTimers();
        imageTimer = setTimeout(nextItem, 5000);
    }

    // Barra de progresso verde
    function startCountdown(duration) {
        const bar = document.getElementById('countdownBar');
        if (!bar) return;
        bar.style.display = 'block';
        bar.style.transition = 'none';
        bar.style.width = '100%';
        // Pequeno delay para o CSS "enxergar" o reset
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                bar.style.transition = `width ${duration}ms linear`;
                bar.style.width = '0%';
            });
        });
    }

    function hideCountdown() {
        const bar = document.getElementById('countdownBar');
        if (bar) { bar.style.display = 'none'; bar.style.width = '0'; }
    }

    function extractYTId(url) {
        if (!url) return null;
        const m = url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|v\/))([^&?#]{11})/);
        return m ? m[1] : null;
    }

    function ativarSom() {
        isMuted = false;
        const btn = document.getElementById('btnSom');
        if (btn) btn.style.display = 'none';
        // Recarrega o item atual com som
        if (playlistActive && playlist[playIndex]?.type === 'youtube') playItem();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SISTEMA PRINCIPAL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // POLLING CONFIGUR√ÅVEL ‚Äî poupa Firebase (sem listeners em tempo real)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const OPCOES_POLLING = [
        { label: '3 min',  ms: 3   * 60 * 1000 },
        { label: '5 min',  ms: 5   * 60 * 1000 },
        { label: '15 min', ms: 15  * 60 * 1000 },
        { label: '30 min', ms: 30  * 60 * 1000 },
        { label: '1 hora', ms: 60  * 60 * 1000 },
    ];
    const CHAVE_INTERVALO = 'pmpf_polling_' + unidadeID; // chave √∫nica por unidade
    let pollingTimer      = null;
    let pollingIntervalMs = parseInt(localStorage.getItem(CHAVE_INTERVALO)) || OPCOES_POLLING[1].ms; // padr√£o 5 min
    let ultimaAtualizacao = null; // timestamp da √∫ltima leitura Firebase

    function salvarIntervaloPolling(ms) {
        pollingIntervalMs = ms;
        localStorage.setItem(CHAVE_INTERVALO, ms);
    }

    function iniciarPolling() {
        if (pollingTimer) clearTimeout(pollingTimer);
        executarPolling(); // disparo imediato
    }

    async function executarPolling() {
        console.log(`üîÑ Polling Firebase [${unidadeID}] ${new Date().toLocaleTimeString('pt-BR')}`);
        try {
            // 1. Busca dados gerais (v√≠deos, flyers, avisos centrais)
            const snapGeral = await db.ref('paineis/geral').once('value');
            const novoGeral = snapGeral.val();
            if (novoGeral) {
                const videoAntes  = JSON.stringify(dadosGerais.unidade?.videoUrls);
                const flayerAntes = JSON.stringify(dadosGerais.flayers);
                dadosGerais = novoGeral;
                if (!dadosGerais.flayers) dadosGerais.flayers = [];
                // Se v√≠deos ou flyers mudaram, reinicia playlist
                const videoDepois  = JSON.stringify(dadosGerais.unidade?.videoUrls);
                const flayerDepois = JSON.stringify(dadosGerais.flayers);
                if (videoAntes !== videoDepois || flayerAntes !== flayerDepois) {
                    console.log('üé¨ M√≠dia da Central atualizada ‚Üí reiniciando playlist');
                    startPlaylist();
                }
            }

            // 2. Busca dados da unidade (falt√¥metro, atendimentos, avisos locais)
            if (!isMatriz) {
                const snapUnidade = await db.ref('paineis/' + unidadeID).once('value');
                const novaUnidade = snapUnidade.val();
                if (novaUnidade) dadosUnidade = novaUnidade;
            }

            processarInterface();
            ultimaAtualizacao = Date.now();
            atualizarStatusPollingUI();
        } catch(e) {
            console.warn('‚ö†Ô∏è Erro no polling:', e.message);
        }

        // Agenda pr√≥xima execu√ß√£o
        pollingTimer = setTimeout(executarPolling, pollingIntervalMs);
    }

    // Atualiza o status no painel de Sincroniza√ß√£o (se estiver aberto)
    function atualizarStatusPollingUI() {
        const el = document.getElementById('pollingStatus');
        const ct = document.getElementById('pollingCountdown');
        if (el && ultimaAtualizacao) {
            el.textContent = new Date(ultimaAtualizacao).toLocaleTimeString('pt-BR');
        }
        if (ct) iniciarCountdownUI();
    }

    let countdownUITimer = null;
    function iniciarCountdownUI() {
        if (countdownUITimer) clearInterval(countdownUITimer);
        const ct = document.getElementById('pollingCountdown');
        if (!ct) return;
        countdownUITimer = setInterval(() => {
            if (!ultimaAtualizacao) return;
            const prox = ultimaAtualizacao + pollingIntervalMs;
            const restante = Math.max(0, prox - Date.now());
            const min = Math.floor(restante / 60000);
            const sec = Math.floor((restante % 60000) / 1000);
            ct.textContent = `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
            const pct = ((pollingIntervalMs - restante) / pollingIntervalMs) * 100;
            const bar = document.getElementById('pollingProgressBar');
            if (bar) bar.style.width = pct + '%';
            if (restante === 0) { clearInterval(countdownUITimer); }
        }, 1000);
    }

    async function iniciarSistema() {
        const lo = document.getElementById('loadingOverlay');
        lo.style.display = 'flex';
        document.getElementById('loadingText').textContent = 'Iniciando sistema...';

        document.getElementById('mainTitle').textContent = isMatriz
            ? 'Matriz ‚Äî Sistema de Sa√∫de Municipal' : 'Unidade de Sa√∫de';
        document.getElementById('headerSubtitle').textContent = 'PMPF ‚Äî Sistema de Sa√∫de';

        atualizarRelogio();
        setInterval(atualizarRelogio, 1000);
        iniciarAnimacaoCarrossel();

        // Carregar dados da matriz (inclui flayers da Central)
        await db.ref('paineis/geral').once('value').then(snap => {
            const d = snap.val();
            if (d) {
                dadosGerais = d;
                // Garantir que flayers existe no objeto
                if (!dadosGerais.flayers) dadosGerais.flayers = [];
            }
        });

        // Carregar dados da unidade
        await db.ref('paineis/' + unidadeID).once('value').then(snap => {
            const d = snap.val();
            if (d) dadosUnidade = d;
        });

        processarInterface();

        // Inicia polling configur√°vel (substitui listeners em tempo real)
        iniciarPolling();

        setTimeout(() => {
            startPlaylist();
            lo.style.opacity = '0';
            lo.style.transition = 'opacity 0.5s';
            setTimeout(() => { lo.style.display = 'none'; lo.style.opacity = '1'; }, 500);
        }, 1800);

        if (isMatriz) {
            carregarTodasUnidades();
            carregarTodosUsuarios();
        }
    }

    function processarInterface() {
        if (dadosUnidade?.unidade?.nome) {
            document.getElementById('headerSubtitle').textContent = `PMPF ‚Äî ${dadosUnidade.unidade.nome}`;
            const el = document.getElementById('adminUnidadeNome');
            if (el) el.textContent = dadosUnidade.unidade.nome;
        }
        atualizarInterface();
        iniciarAvisos();
    }

    function atualizarRelogio() {
        const n = new Date();
        document.getElementById('currentDate').textContent = n.toLocaleDateString('pt-BR', { weekday:'long', day:'2-digit', month:'long' });
        document.getElementById('currentTime').textContent = n.toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit' });
    }

    function atualizarInterface() {
        renderBloco('itemFaltometro',
            'üî¥ FALT√îMETRO DESTA UNIDADE',
            'TOTAL DE PACIENTES QUE N√ÉO COMPARECERAM NO M√äS ANTERIOR',
            dadosUnidade.unidade.especialidades, 'faltas', 'valor-red', 'red-bg');
        renderBloco('itemAtendimentos',
            'ATENDIMENTOS DESTA UNIDADE',
            'TOTAL M√äS ANTERIOR',
            dadosUnidade.unidade.atendimentos, 'valor', 'valor-white', 'blue-bg');
        renderBloco('itemSMS',
            'PRODU√á√ÉO MUNICIPAL ¬∑ SMS',
            'TOTAL M√äS ANTERIOR',
            dadosGerais.unidade.smsMunicipal, 'valor', 'valor-white', 'purple-bg');
    }

    function renderBloco(id, titulo, label, lista, chave, corClass, bgClass) {
        const itens  = lista || [];
        const total  = itens.reduce((a, b) => a + (parseInt(b[chave]) || 0), 0);

        // Detecta se √© falt√¥metro pelo label longo (mensagem diferenciada)
        const isFalto = label.includes('n√£o comparecimento');

        const labelHtml = isFalto
            ? `<div class="total-label total-label-warn">${label}</div>`
            : `<div class="total-label">${label}</div>`;

        let html = `<h2 class="section-title">${titulo}</h2>`;
        html += `<div class="total-container ${bgClass}">
                    ${labelHtml}
                    <div class="total-value">${total.toLocaleString('pt-BR')}</div>
                 </div>`;
        html += `<div class="lista-container">`;
        itens.forEach(e => {
            html += `<div class="item-lista">
                        <span class="item-nome">${e.nome}</span>
                        <span class="item-valor ${corClass}">${(e[chave] || 0).toLocaleString('pt-BR')}</span>
                     </div>`;
        });
        html += `</div>`;
        document.getElementById(id).innerHTML = html;
    }

    function iniciarAnimacaoCarrossel() {
        const slides = document.querySelectorAll('.carousel-item');
        setInterval(() => {
            slides.forEach(s => s.classList.remove('active'));
            carouselIndex = (carouselIndex + 1) % slides.length;
            if (slides[carouselIndex]) slides[carouselIndex].classList.add('active');
        }, 60000);
    }

    function iniciarAvisos() {
        const container = document.getElementById('tickerContainer');
        const avisos = [...(dadosGerais.avisos||[]),...(dadosUnidade.avisos||[])].filter(a=>a&&a.trim());
        if (tickerInterval) clearInterval(tickerInterval);
        if (!avisos.length) {
            container.innerHTML = '<div class="ticker-item" style="opacity:1;transform:none;">Nenhum aviso no momento.</div>';
            return;
        }
        container.innerHTML = avisos.map(a=>`<div class="ticker-item">${a}</div>`).join('');
        const items = container.querySelectorAll('.ticker-item');
        let idx = 0;
        const show = () => {
            items.forEach(i=>{ i.classList.remove('active'); i.style.opacity='0'; });
            if (items.length === 1) { items[0].style.opacity='1'; items[0].style.transform='none'; return; }
            if (items[idx]) items[idx].classList.add('active');
            idx = (idx+1) % items.length;
        };
        show();
        if (items.length > 1) tickerInterval = setInterval(show, 30000);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // AUTENTICA√á√ÉO
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function openLogin() {
        if (usuarioAtual) { mostrarInfoUsuario(); }
        else {
            document.getElementById('loginMethods').style.display = 'block';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('loginUsuario').value = '';
            document.getElementById('loginSenha').value = '';
        }
        document.getElementById('loginScreen').style.display = 'flex';
        setTimeout(()=>{ const el=document.getElementById('loginUsuario'); if(el) el.focus(); }, 100);
    }

    function fecharLogin() {
        document.getElementById('loginScreen').style.display = 'none';
    }

    function verificarLogin() {
        const usuario = document.getElementById('loginUsuario').value.trim();
        const senha   = document.getElementById('loginSenha').value;
        if (!usuario || !senha) { mostrarNotificacao('Preencha todos os campos!','error'); return; }

        // ‚îÄ‚îÄ Fallback local: admin emergencial (n√£o depende do Firebase) ‚îÄ‚îÄ
        if (usuario === ADMIN_EMERGENCIAL.login && senha === ADMIN_EMERGENCIAL.senha) {
            usuarioAtual = { login: usuario, nome: ADMIN_EMERGENCIAL.nome, usuarioKey: 'admin_gti' };
            permissoesUsuario = { ...ADMIN_EMERGENCIAL };
            // Garantir que existe no Firebase em background
            garantirAdminNoFirebase();
            mostrarInfoUsuario();
            return;
        }

        // ‚îÄ‚îÄ Busca no Firebase ‚îÄ‚îÄ
        db.ref('usuarios').once('value').then(snap => {
            const usuarios = snap.val() || {};
            let found = null; let foundKey = null;
            Object.entries(usuarios).forEach(([k,d]) => { if (d && d.login === usuario) { found=d; foundKey=k; } });

            if (!found) { mostrarNotificacao('Usu√°rio n√£o encontrado!','error'); return; }
            if (found.senha !== senha) { mostrarNotificacao('Senha incorreta!','error'); return; }
            if (found.status === 'inativo') { mostrarNotificacao('Usu√°rio desativado!','error'); return; }

            usuarioAtual = { login:usuario, nome:found.nome, usuarioKey:foundKey };
            permissoesUsuario = found;

            if (temAcessoUnidade()) mostrarInfoUsuario();
            else {
                mostrarNotificacao('Sem permiss√£o para esta unidade.','error');
                usuarioAtual = null; permissoesUsuario = null;
            }
        }).catch(err => {
            console.error('Erro Firebase ao verificar login:', err);
            mostrarNotificacao('Erro ao verificar credenciais. Tente novamente.','error');
        });
    }

    // Garante que o admin_gti existe no Firebase (cria se n√£o existir)
    function garantirAdminNoFirebase() {
        db.ref('usuarios/admin_gti').once('value').then(snap => {
            if (!snap.exists()) {
                db.ref('usuarios/admin_gti').set({
                    nome: 'Administrador GTI', login: 'gti', senha: 'Itatilac2009',
                    nivel: 'super_admin', unidades_permitidas: ['todas'],
                    status: 'ativo', data_criacao: new Date().toISOString(), criado_por: 'sistema'
                }).then(() => console.log('‚úÖ admin_gti criado no Firebase'));
            }
        }).catch(e => console.warn('Aviso: n√£o foi poss√≠vel verificar/criar admin no Firebase:', e));
    }

    function temAcessoUnidade() {
        if (!permissoesUsuario) return false;
        if (permissoesUsuario.nivel === 'super_admin') return true;
        const up = permissoesUsuario.unidades_permitidas || [];
        return up.includes('todas') || up.includes(unidadeID);
    }

    function mostrarInfoUsuario() {
        document.getElementById('userName').textContent = usuarioAtual.nome || usuarioAtual.login;
        const n = permissoesUsuario?.nivel;
        const el = document.getElementById('userRole');
        if (n === 'super_admin')     { el.textContent='Super Admin';       el.className='role-badge role-super'; }
        else if (n==='admin_unidade'){ el.textContent='Admin Unidade';     el.className='role-badge role-admin'; }
        else                         { el.textContent='Visualizador';      el.className='role-badge role-viewer'; }
        document.getElementById('loginMethods').style.display = 'none';
        document.getElementById('userInfo').style.display = 'block';
    }

    function continuarParaPainel() {
        configurarMenusPorPermissao();
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminPanel').style.display  = 'flex';
        document.getElementById('adminUserName').textContent = usuarioAtual.nome || usuarioAtual.login;
        mostrarSecao('unidade');
    }

    function configurarMenusPorPermissao() {
        const n   = permissoesUsuario?.nivel;
        const isSA  = n === 'super_admin';
        const isAdm = n === 'admin_unidade' || isSA;
        const show  = (id, v) => { const el = document.getElementById(id); if (el) el.style.display = v ? 'block' : 'none'; };

        // ‚îÄ‚îÄ Minha Unidade ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Falt√¥metro e Atendimentos: cada unidade gerencia os seus
        show('menuFalto',          isAdm);
        show('menuAtend',          isAdm);
        // Avisos da pr√≥pria unidade: todo admin pode gerenciar os seus
        show('menuAvisosUnidade',  isAdm);

        // ‚îÄ‚îÄ Central (somente Matriz) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // Avisos da Central, Flyers, V√≠deos, Produ√ß√£o Municipal: somente Matriz
        show('groupCentral',       isMatriz && isAdm);
        show('menuAvisosCentral',  isMatriz && isAdm);
        show('menuFlayers',        isMatriz && isAdm);   // Flyers: somente Central
        show('menuVideo',          isMatriz && isAdm);   // V√≠deos: somente Central
        show('menuSMS',            isMatriz && isAdm);   // Produ√ß√£o Municipal: somente Central

        // ‚îÄ‚îÄ Administra√ß√£o (somente super_admin na Matriz) ‚îÄ‚îÄ
        show('groupAdmin',         isSA && isMatriz);
        show('menuUsuarios',       isSA && isMatriz);
        show('menuUnidades',       isSA && isMatriz);
        show('menuMonitor',        isSA && isMatriz);
        show('menuSincronizacao',  isSA && isMatriz);
        show('menuBackup',         isSA && isMatriz);
    }

    function trocarUsuario() { usuarioAtual=null; permissoesUsuario=null; openLogin(); }
    function logout() { 
        usuarioAtual=null; permissoesUsuario=null; 
        document.getElementById('adminPanel').style.display='none'; 
        mostrarNotificacao('Sess√£o encerrada.','info'); 
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SE√á√ïES DO PAINEL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function verificarAcessoSecao(secao) {
        if (!permissoesUsuario) return false;
        const n    = permissoesUsuario.nivel;
        const isSA = n === 'super_admin';
        const isAdm = n === 'admin_unidade' || isSA;

        // super_admin acessa tudo
        if (isSA) return true;

        // visualizador: apenas identifica√ß√£o e meus avisos
        if (n === 'visualizador') return ['unidade','avisos_unidade'].includes(secao);

        // admin_unidade: se√ß√µes comuns a todas as unidades
        const secoesComuns = ['unidade','faltometro','atendimentos','avisos_unidade'];
        if (isAdm && secoesComuns.includes(secao)) return true;

        // Se√ß√µes exclusivas da Matriz (Central) ‚Äî Flyers, V√≠deos, SMS, avisos centrais
        const secoesCentral = ['avisos_central','flayers','video','sms'];
        if (isAdm && isMatriz && secoesCentral.includes(secao)) return true;

        return false;
    }

    function mostrarSecao(secao) {
        if (!verificarAcessoSecao(secao)) { mostrarNotificacao('Sem permiss√£o para esta se√ß√£o.','error'); return; }
        document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
        const a = document.querySelector(`.sidebar-item[onclick*="'${secao}'"]`);
        if (a) a.classList.add('active');

        const SECOES = {
            'usuarios':        mostrarGerenciamentoUsuarios,
            'sincronizacao':   mostrarSincronizacao,
            'unidades':        mostrarTodasUnidades,
            'monitor':         mostrarMonitorInatividade,
            'flayers':         mostrarSecaoFlayers,
            'unidade':         mostrarSecaoUnidade,
            'faltometro':      () => mostrarSecaoLista('faltometro'),
            'atendimentos':    () => mostrarSecaoLista('atendimentos'),
            'avisos_unidade':  mostrarSecaoAvisosUnidade,
            'avisos_central':  mostrarSecaoAvisosCentral,
            'video':           mostrarSecaoVideo,
            'sms':             mostrarSecaoSMS,
            'backup':          mostrarSecaoBackup,
        };
        if (SECOES[secao]) SECOES[secao]();
    }

    // ‚îÄ‚îÄ‚îÄ Unidade ‚îÄ‚îÄ‚îÄ
    function mostrarSecaoUnidade() {
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>Identifica√ß√£o da ${isMatriz?'Matriz':'Unidade'}</h2>
                <p>Configure o nome que aparecer√° no painel p√∫blico.</p>
            </div>
            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-hospital"></i></span> Nome da ${isMatriz?'Matriz':'Unidade'}</h3>
                <label class="form-label">Nome</label>
                <input id="uNome" class="form-input" value="${dadosUnidade.unidade.nome||''}" placeholder="Nome da unidade" style="max-width:480px;">
                <div style="margin-top:20px;">
                    <button class="btn btn-primary" onclick="atualizarNomeUnidade()"><i class="fas fa-save"></i> Salvar</button>
                </div>
            </div>`;
    }

    // ‚îÄ‚îÄ‚îÄ Lista (falt√¥metro / atendimentos) ‚îÄ‚îÄ‚îÄ
    function mostrarSecaoLista(secao) {
        const chave = secao==='faltometro' ? 'especialidades' : 'atendimentos';
        const subChave = secao==='faltometro' ? 'faltas' : 'valor';
        const titulo = secao==='faltometro' ? 'Falt√¥metro' : 'Atendimentos da Unidade';
        const lista = dadosUnidade.unidade[chave] || [];

        const isViewer = permissoesUsuario?.nivel === 'visualizador';
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>${titulo}</h2>
                <p>${isViewer ? 'Visualiza√ß√£o somente leitura.' : 'Altera√ß√µes s√£o enviadas automaticamente para os pain√©is.'}</p>
            </div>
            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-list"></i></span> Itens</h3>
                ${isViewer ? renderSomenteLeitura(lista, subChave) : `
                <div id="listaAdmin">
                    ${lista.map((e,i) => `
                        <div class="item-row">
                            <input class="form-input" value="${e.nome}" placeholder="Nome" onchange="atualizarItem(${i},'${chave}',this.value,'nome')">
                            <input class="form-input" type="number" value="${e[subChave]||0}" onchange="atualizarItem(${i},'${chave}',this.value,'${subChave}')">
                            <button class="btn-icon btn-icon-remove" onclick="removerItem(${i},'${chave}')"><i class="fas fa-trash"></i></button>
                        </div>`).join('')}
                </div>
                <div style="margin-top:16px;">
                    <button class="btn btn-primary" onclick="adicionarItem('${chave}','${subChave}')"><i class="fas fa-plus"></i> Adicionar Item</button>
                </div>`}
            </div>`;
    }

    // ‚îÄ‚îÄ‚îÄ Avisos da pr√≥pria unidade (qualquer admin edita os seus) ‚îÄ‚îÄ‚îÄ
    function mostrarSecaoAvisosUnidade() {
        const avisosCentral = dadosGerais.avisos || [];
        const avisosUnidade = dadosUnidade.avisos || [];
        const isViewer = permissoesUsuario?.nivel === 'visualizador';

        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>Meus Avisos</h2>
                <p>Avisos exclusivos desta unidade, exibidos no painel ao lado dos avisos da Central.</p>
            </div>

            ${avisosCentral.length > 0 ? `
            <div class="card" style="border-left:4px solid #f59e0b;">
                <h3><span class="card-icon" style="background:#fffbeb;color:#b45309;"><i class="fas fa-satellite-dish"></i></span>
                    Avisos da Central <span style="font-size:12px;font-weight:400;color:#94a3b8;margin-left:8px;">(somente leitura ‚Äî gerenciados pela Central)</span>
                </h3>
                <div style="background:#fffbeb;border:1px solid #fde68a;border-radius:10px;padding:16px;display:flex;flex-direction:column;gap:8px;">
                    ${avisosCentral.map(a => `
                        <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:white;border-radius:8px;border:1px solid #fde68a;">
                            <i class="fas fa-bullhorn" style="color:#d97706;font-size:13px;flex-shrink:0;"></i>
                            <span style="font-size:14px;color:#78350f;">${a}</span>
                            <span style="margin-left:auto;font-size:11px;background:#fef3c7;color:#b45309;padding:2px 8px;border-radius:12px;">Central</span>
                        </div>`).join('')}
                </div>
                <p style="font-size:12px;color:#94a3b8;margin-top:10px;display:flex;align-items:center;gap:6px;">
                    <i class="fas fa-lock"></i> Apenas a Central pode alterar estes avisos.
                </p>
            </div>` : ''}

            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-bell"></i></span> Avisos desta Unidade
                    <span style="font-size:12px;font-weight:400;color:#94a3b8;margin-left:8px;">(voc√™ edita estes)</span>
                </h3>
                <div class="info-banner"><i class="fas fa-info-circle"></i>
                    Estes avisos aparecem <strong>apenas nesta unidade</strong>, junto com os avisos da Central.
                    Digite um aviso por linha.
                </div>
                ${isViewer ? `
                    <div style="background:#f8fafc;border-radius:10px;padding:16px;">${renderListaAvisosLeitura(avisosUnidade)}</div>
                ` : `
                    <textarea id="txtAvisosUnidade" class="form-input" placeholder="Ex: Amanh√£ n√£o haver√° atendimento das 12h √†s 14h&#10;Vacina√ß√£o contra gripe dispon√≠vel na recep√ß√£o">${avisosUnidade.join('\n')}</textarea>
                    <div style="margin-top:16px;display:flex;gap:10px;">
                        <button class="btn btn-primary" onclick="salvarAvisosUnidade()"><i class="fas fa-save"></i> Salvar Avisos</button>
                        <button class="btn btn-ghost" onclick="document.getElementById('txtAvisosUnidade').value=''">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                    </div>
                `}
            </div>`;
    }

    // ‚îÄ‚îÄ‚îÄ Avisos da Central (somente Matriz/Central edita) ‚îÄ‚îÄ‚îÄ
    function mostrarSecaoAvisosCentral() {
        if (!isMatriz) {
            mostrarRestrito('Avisos da Central', 'Apenas a Central pode gerenciar os avisos globais.');
            return;
        }
        const avisos = dadosGerais.avisos || [];
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>Avisos da Central</h2>
                <p>Avisos globais exibidos em <strong>todas as unidades</strong>. As unidades n√£o podem alterar estes avisos.</p>
            </div>
            <div class="card">
                <h3><span class="card-icon" style="background:#fffbeb;color:#b45309;"><i class="fas fa-satellite-dish"></i></span> Avisos Globais</h3>
                <div class="info-banner" style="background:#fffbeb;border-color:#fde68a;color:#92400e;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Estes avisos aparecem em <strong>TODAS</strong> as unidades e <strong>n√£o podem ser editados pelas unidades</strong>.
                    Use para comunicados importantes e urgentes.
                </div>
                <textarea id="txtAvisosCentral" class="form-input" placeholder="Ex: Aten√ß√£o: sistema de sa√∫de em manuten√ß√£o na sexta-feira&#10;Campanha de vacina√ß√£o municipal inicia na pr√≥xima semana">${avisos.join('\n')}</textarea>
                <div style="margin-top:16px;display:flex;gap:10px;">
                    <button class="btn btn-primary" onclick="salvarAvisosCentral()"><i class="fas fa-save"></i> Salvar Avisos da Central</button>
                    <button class="btn btn-ghost" onclick="document.getElementById('txtAvisosCentral').value=''">
                        <i class="fas fa-eraser"></i> Limpar Todos
                    </button>
                </div>
            </div>

            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-eye"></i></span> Pr√©-visualiza√ß√£o</h3>
                <p style="font-size:13px;color:#64748b;margin-bottom:16px;">Como aparecem no ticker das unidades:</p>
                <div style="background:#0d1f3c;border-radius:10px;padding:20px;display:flex;flex-direction:column;gap:8px;min-height:60px;">
                    ${avisos.length === 0
                        ? '<p style="color:#475569;text-align:center;font-size:13px;">Nenhum aviso cadastrado</p>'
                        : avisos.map(a => `
                            <div style="display:flex;align-items:center;gap:10px;padding:10px 16px;background:rgba(15,98,254,0.12);border-left:3px solid #3b82f6;border-radius:6px;">
                                <i class="fas fa-bullhorn" style="color:#60a5fa;font-size:12px;"></i>
                                <span style="color:#e2e8f0;font-size:14px;">${a}</span>
                            </div>`).join('')}
                </div>
            </div>`;
    }

    function renderListaAvisosLeitura(avisos) {
        if (!avisos.length) return '<p style="color:#94a3b8;font-size:13px;">Nenhum aviso cadastrado.</p>';
        return avisos.map(a => `<div style="padding:10px 14px;background:white;border-radius:8px;border:1px solid #e2e8f0;margin-bottom:8px;font-size:14px;color:#475569;">${a}</div>`).join('');
    }

    // ‚îÄ‚îÄ‚îÄ V√≠deos ‚îÄ‚îÄ‚îÄ
    function mostrarSecaoVideo() {
        if (!isMatriz) { mostrarRestrito('V√≠deos YouTube','Esta se√ß√£o s√≥ existe na Matriz.'); return; }
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>V√≠deos YouTube</h2>
                <p>Os v√≠deos s√£o reproduzidos em todas as unidades, um por vez at√© terminar.</p>
            </div>
            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-play-circle"></i></span> URLs dos V√≠deos</h3>
                <div class="info-banner"><i class="fas fa-info-circle"></i> Cole uma URL do YouTube por linha. Os v√≠deos ser√£o tocados na sequ√™ncia at√© terminar, depois o pr√≥ximo inicia.</div>
                <textarea id="vUrls" class="form-input" placeholder="https://youtu.be/...
https://www.youtube.com/watch?v=...">${(dadosGerais.unidade.videoUrls||[]).join('\n')}</textarea>
                <div style="margin-top:16px; display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="salvarVideos()"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn btn-ghost" onclick="startPlaylist()"><i class="fas fa-redo"></i> Reiniciar Playlist</button>
                </div>
            </div>`;
    }

    // ‚îÄ‚îÄ‚îÄ SMS / Produ√ß√£o Municipal ‚îÄ‚îÄ‚îÄ
    function mostrarSecaoSMS() {
        if (!isMatriz) { mostrarRestrito('Produ√ß√£o Municipal','Esta se√ß√£o s√≥ existe na Matriz.'); return; }
        const lista = dadosGerais.unidade.smsMunicipal || [];
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>Produ√ß√£o Municipal</h2>
                <p>Dados exibidos em TODAS as unidades (coluna direita).</p>
            </div>
            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-city"></i></span> Itens</h3>
                <div id="listaAdmin">
                    ${lista.map((e,i)=>`
                        <div class="item-row">
                            <input class="form-input" value="${e.nome}" placeholder="Nome" onchange="atualizarItemGeral(${i},'smsMunicipal',this.value,'nome')">
                            <input class="form-input" type="number" value="${e.valor||0}" onchange="atualizarItemGeral(${i},'smsMunicipal',this.value,'valor')">
                            <button class="btn-icon btn-icon-remove" onclick="removerItemGeral(${i},'smsMunicipal')"><i class="fas fa-trash"></i></button>
                        </div>`).join('')}
                </div>
                <div style="margin-top:16px;">
                    <button class="btn btn-primary" onclick="adicionarItemGeral('smsMunicipal','valor')"><i class="fas fa-plus"></i> Adicionar</button>
                </div>
            </div>`;
    }

    function mostrarRestrito(titulo, msg) {
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header"><h2>${titulo}</h2></div>
            <div class="card" style="text-align:center;padding:60px 40px;">
                <i class="fas fa-lock" style="font-size:48px;color:#94a3b8;margin-bottom:20px;display:block;"></i>
                <h3 style="font-size:18px;color:#475569;margin-bottom:10px;border:none;">Acesso Restrito</h3>
                <p style="color:#94a3b8;">${msg}</p>
            </div>`;
    }

    function renderSomenteLeitura(lista, chave) {
        if (!lista.length) return '<p style="color:#94a3b8;text-align:center;padding:30px;">Nenhum dado</p>';
        return `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;">
            ${lista.map(e=>`<div style="background:#f8fafc;padding:14px;border-radius:10px;border:1px solid #e2e8f0;">
                <div style="font-size:13px;color:#64748b;margin-bottom:6px;">${e.nome}</div>
                <div style="font-size:22px;font-weight:800;color:#1e293b;font-family:'JetBrains Mono',monospace;">${e[chave]||0}</div>
            </div>`).join('')}
        </div>`;
    }

    // ‚îÄ‚îÄ‚îÄ Sincroniza√ß√£o ‚îÄ‚îÄ‚îÄ
    function mostrarSincronizacao() {
        const opcaoAtual = OPCOES_POLLING.find(o => o.ms === pollingIntervalMs) || OPCOES_POLLING[1];
        const proxima = ultimaAtualizacao ? new Date(ultimaAtualizacao + pollingIntervalMs).toLocaleTimeString('pt-BR') : '‚Äî';

        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>Sincroniza√ß√£o</h2>
                <p>Controle o intervalo de atualiza√ß√£o para economizar leituras do Firebase.</p>
            </div>

            <!-- Card: Intervalo de Atualiza√ß√£o -->
            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-sliders-h"></i></span> Intervalo de Atualiza√ß√£o</h3>
                <div class="info-banner">
                    <i class="fas fa-info-circle"></i>
                    Cada unidade atualiza <strong>de forma independente</strong> no intervalo configurado.
                    Intervalos maiores poupam mais leituras do Firebase e consomem menos internet.
                </div>

                <!-- Bot√µes de sele√ß√£o de intervalo -->
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:20px;">
                    ${OPCOES_POLLING.map(o => `
                        <button id="btnPoll_${o.ms}"
                            class="btn ${o.ms === pollingIntervalMs ? 'btn-primary' : 'btn-ghost'}"
                            style="min-width:90px;font-size:15px;font-weight:700;border-radius:12px;"
                            onclick="selecionarIntervalo(${o.ms})">
                            ${o.label}
                        </button>`).join('')}
                </div>
                <p style="font-size:13px;color:#64748b;margin-top:14px;">
                    <i class="fas fa-check-circle" style="color:#22c55e;"></i>
                    Intervalo atual: <strong>${opcaoAtual.label}</strong>
                </p>
            </div>

            <!-- Card: Status em tempo real -->
            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-satellite-dish"></i></span> Status desta Unidade</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px;">
                    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:16px;text-align:center;">
                        <div style="font-size:11px;font-weight:600;color:#16a34a;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">
                            <i class="fas fa-clock"></i> √öltima atualiza√ß√£o
                        </div>
                        <div id="pollingStatus" style="font-size:22px;font-weight:800;color:#15803d;font-family:'JetBrains Mono',monospace;">
                            ${ultimaAtualizacao ? new Date(ultimaAtualizacao).toLocaleTimeString('pt-BR') : '‚Äî'}
                        </div>
                    </div>
                    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:12px;padding:16px;text-align:center;">
                        <div style="font-size:11px;font-weight:600;color:#1d4ed8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">
                            <i class="fas fa-hourglass-half"></i> Pr√≥xima em
                        </div>
                        <div id="pollingCountdown" style="font-size:22px;font-weight:800;color:#1d4ed8;font-family:'JetBrains Mono',monospace;">00:00</div>
                    </div>
                    <div style="background:#faf5ff;border:1px solid #e9d5ff;border-radius:12px;padding:16px;text-align:center;">
                        <div style="font-size:11px;font-weight:600;color:#7e22ce;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;">
                            <i class="fas fa-wifi"></i> Intervalo ativo
                        </div>
                        <div style="font-size:22px;font-weight:800;color:#7e22ce;font-family:'JetBrains Mono',monospace;">${opcaoAtual.label}</div>
                    </div>
                </div>

                <!-- Barra de progresso at√© pr√≥xima atualiza√ß√£o -->
                <div style="margin-bottom:16px;">
                    <div style="display:flex;justify-content:space-between;font-size:12px;color:#94a3b8;margin-bottom:6px;">
                        <span>Progresso at√© pr√≥xima leitura</span>
                        <span>Pr√≥xima: ${proxima}</span>
                    </div>
                    <div style="background:#e2e8f0;border-radius:99px;height:8px;overflow:hidden;">
                        <div id="pollingProgressBar" style="height:100%;background:linear-gradient(90deg,#0f62fe,#00b4d8);border-radius:99px;width:0%;transition:width 1s linear;"></div>
                    </div>
                </div>

                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="forcarAtualizacao()">
                        <i class="fas fa-sync-alt"></i> Atualizar agora
                    </button>
                    <button class="btn btn-ghost" onclick="startPlaylist()">
                        <i class="fas fa-redo"></i> Reiniciar Playlist
                    </button>
                </div>
            </div>

            <!-- Card: Estimativa de economia -->
            <div class="card">
                <h3><span class="card-icon" style="background:#fff7ed;color:#c2410c;"><i class="fas fa-database"></i></span> Estimativa de Leituras Firebase</h3>
                <div style="overflow-x:auto;">
                    <table style="width:100%;border-collapse:collapse;font-size:14px;">
                        <thead>
                            <tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0;">
                                <th style="padding:12px 16px;text-align:left;color:#475569;font-weight:600;">Intervalo</th>
                                <th style="padding:12px 16px;text-align:center;color:#475569;font-weight:600;">Leituras/hora</th>
                                <th style="padding:12px 16px;text-align:center;color:#475569;font-weight:600;">Leituras/dia</th>
                                <th style="padding:12px 16px;text-align:center;color:#475569;font-weight:600;">Leituras/m√™s</th>
                                <th style="padding:12px 16px;text-align:center;color:#475569;font-weight:600;">Economia vs 3min</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${OPCOES_POLLING.map((o,i) => {
                                const por_hora = Math.round(3600000 / o.ms) * 2; // geral + unidade
                                const por_dia  = por_hora * 24;
                                const por_mes  = por_dia  * 30;
                                const base = Math.round(3600000 / OPCOES_POLLING[0].ms) * 2 * 24 * 30;
                                const economia = i === 0 ? '‚Äî' : Math.round((1 - por_mes/base)*100) + '%';
                                const ativo = o.ms === pollingIntervalMs;
                                return `<tr style="${ativo ? 'background:#eff6ff;font-weight:700;' : 'border-bottom:1px solid #f1f5f9;'}">
                                    <td style="padding:12px 16px;">
                                        ${ativo ? '<i class="fas fa-check-circle" style="color:#0f62fe;margin-right:6px;"></i>' : ''}
                                        ${o.label}${ativo ? ' <span style="font-size:11px;color:#0f62fe;">(ativo)</span>' : ''}
                                    </td>
                                    <td style="padding:12px 16px;text-align:center;font-family:\'JetBrains Mono\',monospace;">${por_hora}</td>
                                    <td style="padding:12px 16px;text-align:center;font-family:\'JetBrains Mono\',monospace;">${por_dia}</td>
                                    <td style="padding:12px 16px;text-align:center;font-family:\'JetBrains Mono\',monospace;">${por_mes.toLocaleString('pt-BR')}</td>
                                    <td style="padding:12px 16px;text-align:center;">
                                        <span style="background:${i===0?'#fef2f2':i===1?'#fff7ed':'#f0fdf4'};color:${i===0?'#dc2626':i===1?'#ea580c':'#16a34a'};padding:3px 10px;border-radius:20px;font-size:12px;font-weight:600;">
                                            ${economia}
                                        </span>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                <p style="font-size:12px;color:#94a3b8;margin-top:12px;">
                    <i class="fas fa-info-circle"></i>
                    Estimativa: 2 leituras por ciclo (dados gerais + dados da unidade). 
                    Cada unidade opera de forma independente.
                </p>
            </div>`;

        // Inicia o countdown visual
        iniciarCountdownUI();
    }

    function selecionarIntervalo(ms) {
        salvarIntervaloPolling(ms);
        // Atualiza visual dos bot√µes
        OPCOES_POLLING.forEach(o => {
            const btn = document.getElementById('btnPoll_' + o.ms);
            if (btn) {
                btn.className = 'btn ' + (o.ms === ms ? 'btn-primary' : 'btn-ghost');
                btn.style.cssText = 'min-width:90px;font-size:15px;font-weight:700;border-radius:12px;';
            }
        });
        // Reinicia o polling com novo intervalo
        if (pollingTimer) clearTimeout(pollingTimer);
        pollingTimer = setTimeout(executarPolling, pollingIntervalMs);
        mostrarNotificacao(`Intervalo alterado para ${OPCOES_POLLING.find(o=>o.ms===ms)?.label}. Salvo para esta unidade.`, 'success');
        // Re-renderiza a se√ß√£o para atualizar a tabela e o status
        setTimeout(mostrarSincronizacao, 300);
    }

    async function forcarAtualizacao() {
        mostrarNotificacao('Atualizando dados agora...', 'info');
        if (pollingTimer) clearTimeout(pollingTimer);
        await executarPolling();
        mostrarNotificacao('Dados atualizados!', 'success');
        mostrarSincronizacao(); // re-renderiza com hor√°rio atualizado
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // BACKUP / RESTORE ‚Äî GitHub via API
    // Token salvo criptografado em Firebase: configuracoes/github
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    const _e = s => btoa(unescape(encodeURIComponent(s)));
    const _d = s => { try { return decodeURIComponent(escape(atob(s))); } catch(e) { return s; } };

    let ghConfig = { token:'', owner:'', repo:'', path:'painel/backup/backup_completo.json' };
    let backupStatus = { ultimoBackup: null, sha: null };

    async function carregarConfigGitHub() {
        try {
            const snap = await db.ref('configuracoes/github').once('value');
            const cfg  = snap.val();
            if (cfg) {
                ghConfig.token = cfg.token ? _d(cfg.token) : '';
                ghConfig.owner = cfg.owner || '';
                ghConfig.repo  = cfg.repo  || '';
                ghConfig.path  = cfg.path  || 'painel/backup/backup_completo.json';
                backupStatus.ultimoBackup = cfg.ultimo_backup || null;
                backupStatus.sha          = cfg.sha           || null;
            }
        } catch(e) { console.warn('Erro ao carregar config GitHub:', e.message); }
    }

    async function salvarConfigGitHub(token, owner, repo, path) {
        const cfg = {
            token: _e(token), owner, repo,
            path: path || 'painel/backup/backup_completo.json',
            ultimo_backup: backupStatus.ultimoBackup || null,
            sha: backupStatus.sha || null,
        };
        await db.ref('configuracoes/github').set(cfg);
        ghConfig = { token, owner, repo, path: cfg.path };
        mostrarNotificacao('Configura√ß√£o GitHub salva com seguran√ßa no Firebase!', 'success');
    }

    async function coletarDadosCompletos() {
        const [snapPaineis, snapUsuarios] = await Promise.all([
            db.ref('paineis').once('value'),
            db.ref('usuarios').once('value'),
        ]);
        return {
            meta: {
                versao:         '3.4',
                gerado_em:      new Date().toISOString(),
                gerado_por:     usuarioAtual?.nome || 'admin',
                total_unidades: Object.keys(snapPaineis.val() || {}).length,
                total_usuarios: Object.keys(snapUsuarios.val() || {}).length,
            },
            paineis:  snapPaineis.val()  || {},
            usuarios: snapUsuarios.val() || {},
        };
    }

    async function buscarSHAGitHub() {
        if (!ghConfig.token || !ghConfig.owner || !ghConfig.repo) return null;
        try {
            const res = await fetch(
                `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${ghConfig.path}`,
                { headers: { Authorization: `token ${ghConfig.token}`, Accept: 'application/vnd.github.v3+json' } }
            );
            if (!res.ok) return null;
            const data = await res.json();
            return data.sha || null;
        } catch(e) { return null; }
    }

    async function enviarParaGitHub(jsonStr) {
        if (!ghConfig.token || !ghConfig.owner || !ghConfig.repo)
            throw new Error('Configure o token, owner e reposit√≥rio antes de fazer backup.');
        const sha = backupStatus.sha || await buscarSHAGitHub();
        const body = {
            message: `backup: ${new Date().toLocaleString('pt-BR')} ‚Äî via PMPF Sa√∫de`,
            content: btoa(unescape(encodeURIComponent(jsonStr))),
            branch:  'main',
        };
        if (sha) body.sha = sha;
        const res = await fetch(
            `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${ghConfig.path}`,
            {
                method:  'PUT',
                headers: { Authorization: `token ${ghConfig.token}`, Accept: 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body:    JSON.stringify(body),
            }
        );
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.message || `Erro GitHub: ${res.status}`);
        }
        const data = await res.json();
        return data.content?.sha || null;
    }

    async function lerBackupGitHub() {
        if (!ghConfig.token || !ghConfig.owner || !ghConfig.repo)
            throw new Error('Configure o token, owner e reposit√≥rio primeiro.');
        const res = await fetch(
            `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${ghConfig.path}`,
            { headers: { Authorization: `token ${ghConfig.token}`, Accept: 'application/vnd.github.v3+json' } }
        );
        if (!res.ok) throw new Error('Arquivo de backup n√£o encontrado no reposit√≥rio.');
        const data = await res.json();
        return JSON.parse(decodeURIComponent(escape(atob(data.content.replace(/\n/g, '')))));
    }

    async function executarBackup() {
        atualizarBtnBackup(true);
        try {
            mostrarNotificacao('Coletando dados do Firebase...', 'info');
            const dados   = await coletarDadosCompletos();
            const jsonStr = JSON.stringify(dados, null, 2);
            mostrarNotificacao('Enviando para o GitHub...', 'info');
            const novoSha = await enviarParaGitHub(jsonStr);
            backupStatus.sha          = novoSha;
            backupStatus.ultimoBackup = new Date().toISOString();
            await db.ref('configuracoes/github').update({ sha: novoSha, ultimo_backup: backupStatus.ultimoBackup });
            mostrarNotificacao('‚úÖ Backup enviado com sucesso para o GitHub!', 'success');
            mostrarSecaoBackup();
        } catch(e) {
            mostrarNotificacao('Erro no backup: ' + e.message, 'error');
        } finally { atualizarBtnBackup(false); }
    }

    async function executarRestore() {
        if (!confirm(
            'ATEN√á√ÉO: O RESTORE ir√° SUBSTITUIR todos os dados atuais do Firebase pelos dados do backup.\n\n' +
            'Isso afeta:\n‚Ä¢ Todas as unidades\n‚Ä¢ Usu√°rios do sistema\n‚Ä¢ V√≠deos, flyers e SMS Municipal\n\n' +
            'Tem certeza que deseja continuar?'
        )) return;
        atualizarBtnRestore(true);
        try {
            mostrarNotificacao('Lendo backup do GitHub...', 'info');
            const backup = await lerBackupGitHub();
            if (!backup.paineis || !backup.usuarios)
                throw new Error('Arquivo de backup inv√°lido ou corrompido.');
            mostrarNotificacao('Restaurando dados no Firebase...', 'info');
            await Promise.all([
                db.ref('paineis').set(backup.paineis),
                db.ref('usuarios').set(backup.usuarios),
            ]);
            dadosGerais  = backup.paineis?.geral        || dadosGerais;
            dadosUnidade = backup.paineis?.[unidadeID]  || dadosUnidade;
            mostrarNotificacao('‚úÖ Restore conclu√≠do! Dados restaurados com sucesso.', 'success');
            mostrarSecaoBackup();
        } catch(e) {
            mostrarNotificacao('Erro no restore: ' + e.message, 'error');
        } finally { atualizarBtnRestore(false); }
    }

    function atualizarBtnBackup(loading) {
        const btn = document.getElementById('btnExecutarBackup');
        if (!btn) return;
        btn.disabled  = loading;
        btn.innerHTML = loading
            ? '<i class="fas fa-spinner fa-spin"></i> Enviando...'
            : '<i class="fas fa-cloud-upload-alt"></i> Fazer Backup Agora';
    }

    function atualizarBtnRestore(loading) {
        const btn = document.getElementById('btnExecutarRestore');
        if (!btn) return;
        btn.disabled  = loading;
        btn.innerHTML = loading
            ? '<i class="fas fa-spinner fa-spin"></i> Restaurando...'
            : '<i class="fas fa-cloud-download-alt"></i> Restaurar do GitHub';
    }

    async function mostrarSecaoBackup() {
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>Backup / Restore</h2>
                <p>Carregando configura√ß√£o...</p>
            </div>
            <div class="card" style="text-align:center;padding:60px;">
                <div class="loading-ring" style="margin:0 auto 16px;border-top-color:#0f62fe;"></div>
            </div>`;

        await carregarConfigGitHub();

        const temConfig    = !!(ghConfig.token && ghConfig.owner && ghConfig.repo);
        const ultimoBackup = backupStatus.ultimoBackup
            ? new Date(backupStatus.ultimoBackup).toLocaleString('pt-BR') : '‚Äî';
        const disabledAttr = temConfig ? '' : 'disabled';

        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2><i class="fas fa-cloud-upload-alt" style="color:#0f62fe;margin-right:10px;"></i>Backup / Restore</h2>
                <p>Salve e restaure todos os dados no GitHub. Token armazenado com seguran√ßa no Firebase.</p>
            </div>

            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-info-circle"></i></span> Status</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
                    <div style="background:#f0fdf4;border:1px solid #bbf7d0;border-radius:12px;padding:18px;text-align:center;">
                        <div style="font-size:11px;font-weight:700;color:#16a34a;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;"><i class="fas fa-clock"></i> √öltimo Backup</div>
                        <div style="font-size:14px;font-weight:700;color:#15803d;">${ultimoBackup}</div>
                    </div>
                    <div style="background:${temConfig?'#eff6ff':'#fef2f2'};border:1px solid ${temConfig?'#bfdbfe':'#fecaca'};border-radius:12px;padding:18px;text-align:center;">
                        <div style="font-size:11px;font-weight:700;color:${temConfig?'#1d4ed8':'#dc2626'};text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;"><i class="fas fa-plug"></i> Conex√£o GitHub</div>
                        <div style="font-size:14px;font-weight:700;color:${temConfig?'#1d4ed8':'#dc2626'};">${temConfig?'‚úÖ Configurado':'‚ö†Ô∏è N√£o configurado'}</div>
                    </div>
                    <div style="background:#faf5ff;border:1px solid #e9d5ff;border-radius:12px;padding:18px;text-align:center;">
                        <div style="font-size:11px;font-weight:700;color:#7e22ce;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;"><i class="fab fa-github"></i> Reposit√≥rio</div>
                        <div style="font-size:13px;font-weight:700;color:#7e22ce;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${temConfig?ghConfig.owner+'/'+ghConfig.repo:'‚Äî'}</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3><span class="card-icon" style="background:#fff7ed;color:#c2410c;"><i class="fab fa-github"></i></span> Configura√ß√£o GitHub</h3>
                <div class="info-banner" style="background:#f0fdf4;border-color:#bbf7d0;color:#166534;">
                    <i class="fas fa-shield-alt"></i>
                    O token √© <strong>criptografado e salvo no Firebase</strong> ‚Äî nunca fica exposto no c√≥digo ou navegador.
                    Crie um <strong>Personal Access Token (PAT)</strong> com permiss√£o <code>contents:write</code>.
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:16px;">
                    <div>
                        <label class="form-label"><i class="fas fa-user"></i> Owner (usu√°rio ou organiza√ß√£o)</label>
                        <input id="ghOwner" class="form-input" placeholder="ex: prefeitura-passo-fundo" value="${ghConfig.owner}">
                    </div>
                    <div>
                        <label class="form-label"><i class="fab fa-github"></i> Reposit√≥rio</label>
                        <input id="ghRepo" class="form-input" placeholder="ex: painel-saude" value="${ghConfig.repo}">
                    </div>
                </div>
                <div style="margin-top:14px;">
                    <label class="form-label"><i class="fas fa-key"></i> Personal Access Token (PAT)</label>
                    <div style="display:flex;gap:10px;">
                        <input id="ghToken" class="form-input" type="password"
                            placeholder="${temConfig?'‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ (token salvo ‚Äî deixe em branco para manter)':'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'}"
                            style="flex:1;font-family:var(--mono);font-size:13px;">
                        <button class="btn btn-ghost" style="flex-shrink:0;" onclick="
                            const i=document.getElementById('ghToken');
                            i.type=i.type==='password'?'text':'password';
                            this.innerHTML=i.type==='password'?'<i class=\'fas fa-eye\'></i>':'<i class=\'fas fa-eye-slash\'></i>';
                        "><i class="fas fa-eye"></i></button>
                    </div>
                </div>
                <div style="margin-top:14px;">
                    <label class="form-label"><i class="fas fa-folder"></i> Caminho no reposit√≥rio</label>
                    <input id="ghPath" class="form-input" value="${ghConfig.path}" style="font-family:var(--mono);font-size:13px;">
                </div>
                <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="salvarConfigGH()"><i class="fas fa-save"></i> Salvar Configura√ß√£o</button>
                    <button class="btn btn-ghost" onclick="testarConexaoGH()"><i class="fas fa-plug"></i> Testar Conex√£o</button>
                </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <div class="card" style="border-top:4px solid #22c55e;">
                    <h3><span class="card-icon" style="background:#f0fdf4;color:#16a34a;"><i class="fas fa-cloud-upload-alt"></i></span> Fazer Backup</h3>
                    <p style="font-size:14px;color:#64748b;margin-bottom:16px;line-height:1.6;">Exporta <strong>todos os dados</strong> do Firebase em um √∫nico JSON para o GitHub.</p>
                    <div style="background:#f8fafc;border-radius:10px;padding:14px;margin-bottom:16px;font-size:13px;color:#475569;">
                        ${['Todas as unidades (falt√¥metro, atendimentos)','Avisos (central + unidades)','Flyers / URLs de m√≠dia','Usu√°rios do sistema','V√≠deos YouTube e SMS Municipal']
                            .map(t=>`<div style="margin-bottom:5px;"><i class="fas fa-check" style="color:#22c55e;margin-right:8px;"></i>${t}</div>`).join('')}
                    </div>
                    <button id="btnExecutarBackup" class="btn btn-primary" style="width:100%;justify-content:center;background:#16a34a;border-color:#16a34a;" onclick="executarBackup()" ${disabledAttr}>
                        <i class="fas fa-cloud-upload-alt"></i> Fazer Backup Agora
                    </button>
                    ${!temConfig?'<p style="font-size:12px;color:#ef4444;margin-top:8px;text-align:center;">Configure o GitHub primeiro</p>':''}
                </div>
                <div class="card" style="border-top:4px solid #f59e0b;">
                    <h3><span class="card-icon" style="background:#fffbeb;color:#d97706;"><i class="fas fa-cloud-download-alt"></i></span> Restaurar Backup</h3>
                    <p style="font-size:14px;color:#64748b;margin-bottom:16px;line-height:1.6;">L√™ o arquivo JSON do GitHub e <strong>restaura todos os dados</strong> no Firebase.</p>
                    <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:10px;padding:14px;margin-bottom:16px;font-size:13px;color:#78350f;line-height:1.5;">
                        <strong><i class="fas fa-exclamation-triangle"></i> Aten√ß√£o:</strong>
                        O restore <strong>substitui permanentemente</strong> todos os dados atuais. Fa√ßa um backup antes. A opera√ß√£o n√£o pode ser desfeita.
                    </div>
                    <button id="btnExecutarRestore" class="btn btn-danger" style="width:100%;justify-content:center;" onclick="executarRestore()" ${disabledAttr}>
                        <i class="fas fa-cloud-download-alt"></i> Restaurar do GitHub
                    </button>
                    ${!temConfig?'<p style="font-size:12px;color:#ef4444;margin-top:8px;text-align:center;">Configure o GitHub primeiro</p>':''}
                </div>
            </div>

            ${temConfig ? `
            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-history"></i></span> Hist√≥rico de Backups</h3>
                <div id="historicoBackups" style="text-align:center;padding:30px;color:#94a3b8;">
                    <i class="fas fa-spinner fa-spin" style="font-size:24px;display:block;margin-bottom:10px;"></i>Carregando...
                </div>
            </div>` : ''}`;

        if (temConfig) carregarHistoricoGitHub();
    }

    async function salvarConfigGH() {
        const token = document.getElementById('ghToken').value.trim();
        const owner = document.getElementById('ghOwner').value.trim();
        const repo  = document.getElementById('ghRepo').value.trim();
        const path  = document.getElementById('ghPath').value.trim() || 'painel/backup/backup_completo.json';
        if (!owner || !repo) { mostrarNotificacao('Preencha owner e reposit√≥rio.', 'error'); return; }
        if (!token && !ghConfig.token) { mostrarNotificacao('Informe o token do GitHub.', 'error'); return; }
        await salvarConfigGitHub(token || ghConfig.token, owner, repo, path);
        mostrarSecaoBackup();
    }

    async function testarConexaoGH() {
        const token = document.getElementById('ghToken').value.trim() || ghConfig.token;
        const owner = document.getElementById('ghOwner').value.trim() || ghConfig.owner;
        const repo  = document.getElementById('ghRepo').value.trim()  || ghConfig.repo;
        if (!token || !owner || !repo) { mostrarNotificacao('Preencha todos os campos antes de testar.', 'error'); return; }
        mostrarNotificacao('Testando conex√£o...', 'info');
        try {
            const res = await fetch(`https://api.github.com/repos/${owner}/${repo}`,
                { headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' } });
            if (res.ok) {
                const d = await res.json();
                mostrarNotificacao(`‚úÖ Conectado! Reposit√≥rio: ${d.full_name} (${d.private?'privado':'p√∫blico'})`, 'success');
            } else {
                mostrarNotificacao('‚ùå Token inv√°lido ou reposit√≥rio n√£o encontrado.', 'error');
            }
        } catch(e) { mostrarNotificacao('Erro de rede: ' + e.message, 'error'); }
    }

    async function carregarHistoricoGitHub() {
        const el = document.getElementById('historicoBackups');
        if (!el) return;
        try {
            const res = await fetch(
                `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/commits?path=${encodeURIComponent(ghConfig.path)}&per_page=10`,
                { headers: { Authorization: `token ${ghConfig.token}`, Accept: 'application/vnd.github.v3+json' } }
            );
            if (!res.ok) { el.innerHTML = '<p style="color:#94a3b8;text-align:center;">Nenhum backup encontrado ainda.</p>'; return; }
            const commits = await res.json();
            if (!Array.isArray(commits) || !commits.length) {
                el.innerHTML = '<p style="color:#94a3b8;text-align:center;">Nenhum backup encontrado ainda.</p>'; return;
            }
            el.innerHTML = `
                <table style="width:100%;border-collapse:collapse;font-size:14px;">
                    <thead>
                        <tr style="background:#f8fafc;border-bottom:2px solid #e2e8f0;">
                            <th style="padding:10px 16px;text-align:left;color:#475569;font-weight:600;">Data / Hora</th>
                            <th style="padding:10px 16px;text-align:left;color:#475569;font-weight:600;">Mensagem</th>
                            <th style="padding:10px 16px;text-align:center;color:#475569;font-weight:600;">Commit</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${commits.map(c => {
                            const dt  = new Date(c.commit.author.date).toLocaleString('pt-BR');
                            const sha = c.sha.substring(0, 7);
                            const msg = (c.commit.message || '').replace(/^backup:\s*/i,'');
                            return `<tr style="border-bottom:1px solid #f1f5f9;">
                                <td style="padding:10px 16px;color:#1e293b;font-weight:600;">${dt}</td>
                                <td style="padding:10px 16px;color:#475569;">${msg}</td>
                                <td style="padding:10px 16px;text-align:center;"><code style="background:#f1f5f9;padding:2px 8px;border-radius:6px;font-size:12px;">${sha}</code></td>
                            </tr>`;
                        }).join('')}
                    </tbody>
                </table>`;
        } catch(e) {
            el.innerHTML = `<p style="color:#ef4444;text-align:center;">Erro ao carregar hist√≥rico: ${e.message}</p>`;
        }
    }


    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FLAYERS ‚Äî somente Central posta, aparece em todas as unidades
    // Os flyers ficam em paineis/geral/flayers (n√£o por unidade)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function mostrarSecaoFlayers() {
        if (!isMatriz) {
            mostrarRestrito('Flyers / Encartes',
                'Apenas a Central pode gerenciar os flyers e encartes. ' +
                'Os flyers cadastrados aqui aparecem automaticamente em todas as unidades.');
            return;
        }

        const urls = dadosGerais.flayers || [];
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>Flyers / Encartes ‚Äî Central</h2>
                <p>Imagens gerenciadas pela Central. Aparecem em <strong>todas as unidades</strong> ap√≥s os v√≠deos (30 segundos cada).</p>
            </div>
            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-upload"></i></span> Enviar Imagem</h3>
                <div class="upload-zone" onclick="document.getElementById('flayerUpload').click()">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p><strong>Clique para selecionar</strong> ou arraste uma imagem aqui</p>
                    <p style="font-size:12px;margin-top:6px;">JPG, JPEG, PNG ‚Äî m√°x. 5MB</p>
                </div>
                <input type="file" id="flayerUpload" accept="image/jpeg,image/png" style="display:none;" onchange="uploadFlayer()">

                <div style="margin-bottom:20px;">
                    <label class="form-label"><i class="fas fa-link" style="margin-right:6px;"></i>Ou cole URLs (uma por linha):</label>
                    <textarea id="flayerUrls" class="form-input"
                        placeholder="https://exemplo.com/imagem.jpg"
                        style="min-height:100px;font-family:'JetBrains Mono',monospace;font-size:12px;">${urls.join('\n')}</textarea>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="salvarFlayers()"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn btn-danger" onclick="limparTodosFlayers()"><i class="fas fa-trash-alt"></i> Limpar Todos</button>
                </div>
            </div>

            <div class="card">
                <h3><span class="card-icon"><i class="fas fa-th"></i></span> Pr√©-visualiza√ß√£o (${urls.length} flyer${urls.length!==1?'s':''})</h3>
                <div class="flayer-grid">
                    ${urls.length===0 ? `
                        <div style="grid-column:1/-1;text-align:center;padding:40px;color:#94a3b8;">
                            <i class="fas fa-images" style="font-size:40px;display:block;margin-bottom:12px;opacity:0.4;"></i>
                            <p>Nenhum flyer configurado</p>
                        </div>`
                    : urls.map((url,i)=>`
                        <div class="flayer-card">
                            <div class="flayer-img-wrap">
                                <img src="${url}" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                                <div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;color:#94a3b8;font-size:12px;flex-direction:column;gap:6px;">
                                    <i class="fas fa-image" style="font-size:24px;"></i>Erro
                                </div>
                            </div>
                            <div class="flayer-footer">
                                <span class="flayer-num">${i+1}</span>
                                <span style="font-size:10px;color:#94a3b8;flex:1;margin:0 8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${url.length>28?url.substring(0,28)+'‚Ä¶':url}</span>
                                <button class="flayer-del" onclick="removerFlayerEspecifico(${i})"><i class="fas fa-times-circle"></i></button>
                            </div>
                        </div>`).join('')}
                </div>
                <div style="margin-top:20px;padding:16px;background:#f0fdf4;border-radius:10px;border-left:3px solid #22c55e;font-size:13px;color:#166534;">
                    <strong>Ordem de reprodu√ß√£o em todas as unidades:</strong>
                    V√≠deos YouTube (cada um at√© terminar) ‚Üí Flyers da Central (30s cada) ‚Üí reinicia do in√≠cio.
                </div>
            </div>`;
    }

    function uploadFlayer() {
        if (!isMatriz) { mostrarNotificacao('Apenas a Central pode enviar flyers.','error'); return; }
        const fileInput = document.getElementById('flayerUpload');
        if (!fileInput.files?.length) return;
        const file = fileInput.files[0];
        if (!['image/jpeg','image/png'].includes(file.type)) { mostrarNotificacao('Apenas JPG/PNG permitidos.','error'); return; }

        mostrarNotificacao('Enviando imagem...','info');
        const fileName = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g,'_')}`;
        const ref = storage.ref(`flayers/geral/${fileName}`);  // sempre em /geral/
        const task = ref.put(file);

        task.on('state_changed', null,
            () => mostrarNotificacao('Erro ao enviar imagem.','error'),
            () => task.snapshot.ref.getDownloadURL().then(url => {
                const novas = [...(dadosGerais.flayers||[]), url];
                dadosGerais.flayers = novas;
                db.ref('paineis/geral/flayers').set(novas).then(() => {
                    mostrarNotificacao('Imagem enviada e publicada em todas as unidades!','success');
                    mostrarSecaoFlayers();
                });
            })
        );
        fileInput.value = '';
    }

    function salvarFlayers() {
        if (!isMatriz) { mostrarNotificacao('Apenas a Central pode gerenciar flyers.','error'); return; }
        const ta = document.getElementById('flayerUrls');
        if (!ta) return;
        const urls = ta.value.split('\n').map(u=>u.trim()).filter(Boolean);
        dadosGerais.flayers = urls;
        db.ref('paineis/geral/flayers').set(urls).then(() => {
            mostrarNotificacao(`${urls.length} flyer(s) publicados em todas as unidades!`,'success');
            mostrarSecaoFlayers();
        });
    }

    function removerFlayerEspecifico(index) {
        if (!isMatriz) return;
        const urls = [...(dadosGerais.flayers||[])];
        const url = urls[index];
        if (url?.includes('firebasestorage.googleapis.com')) {
            try { storage.refFromURL(url).delete().catch(()=>{}); } catch(e) {}
        }
        urls.splice(index,1);
        dadosGerais.flayers = urls;
        db.ref('paineis/geral/flayers').set(urls).then(() => {
            mostrarNotificacao('Flyer removido de todas as unidades!','success');
            mostrarSecaoFlayers();
        });
    }

    function limparTodosFlayers() {
        if (!isMatriz) return;
        if (!confirm('Remover TODOS os flyers de TODAS as unidades?')) return;
        (dadosGerais.flayers||[]).forEach(u => {
            if (u.includes('firebasestorage.googleapis.com')) {
                try { storage.refFromURL(u).delete().catch(()=>{}); } catch(e) {}
            }
        });
        dadosGerais.flayers = [];
        db.ref('paineis/geral/flayers').set([]).then(() => {
            mostrarNotificacao('Todos os flyers removidos de todas as unidades!','success');
            mostrarSecaoFlayers();
        });
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // DADOS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function atualizarNomeUnidade() {
        const n = document.getElementById('uNome').value;
        dadosUnidade.unidade.nome = n;
        const el = document.getElementById('adminUnidadeNome');
        if (el) el.textContent = n;
        salvarDados(true,'unidade');
    }
    // Salva avisos da pr√≥pria unidade (cada unidade gerencia os seus)
    function salvarAvisosUnidade() {
        const arr = document.getElementById('txtAvisosUnidade').value.split('\n').filter(a => a.trim());
        dadosUnidade.avisos = arr;
        db.ref('paineis/' + unidadeID + '/avisos').set(arr).then(() => {
            mostrarNotificacao('Avisos da unidade salvos!', 'success');
        });
    }

    // Salva avisos da Central (somente Matriz ‚Äî aparecem em todas as unidades)
    function salvarAvisosCentral() {
        if (!isMatriz) { mostrarNotificacao('Apenas a Central pode alterar estes avisos.', 'error'); return; }
        const arr = document.getElementById('txtAvisosCentral').value.split('\n').filter(a => a.trim());
        dadosGerais.avisos = arr;
        db.ref('paineis/geral/avisos').set(arr).then(() => {
            mostrarNotificacao('Avisos da Central salvos! Todas as unidades ser√£o atualizadas.', 'success');
            mostrarSecaoAvisosCentral(); // re-renderiza pr√©-visualiza√ß√£o
        });
    }
    function salvarVideos() {
        dadosGerais.unidade.videoUrls = document.getElementById('vUrls').value.split('\n').filter(u=>u.trim());
        salvarDados(true,'video');
    }
    function atualizarItem(i,chave,val,tipo) {
        if (!dadosUnidade.unidade[chave]) dadosUnidade.unidade[chave]=[];
        if (dadosUnidade.unidade[chave][i]) {
            dadosUnidade.unidade[chave][i][tipo] = tipo==='nome' ? val : (parseInt(val)||0);
            salvarDados(true,chave==='especialidades'?'faltometro':'atendimentos');
        }
    }
    function atualizarItemGeral(i,chave,val,tipo) {
        if (!dadosGerais.unidade[chave]) dadosGerais.unidade[chave]=[];
        if (dadosGerais.unidade[chave][i]) {
            dadosGerais.unidade[chave][i][tipo] = tipo==='nome' ? val : (parseInt(val)||0);
            salvarDados(true,'sms');
        }
    }
    function removerItem(i,chave) {
        if (dadosUnidade.unidade[chave]?.[i] !== undefined) {
            dadosUnidade.unidade[chave].splice(i,1);
            mostrarSecao(chave==='especialidades'?'faltometro':'atendimentos');
            salvarDados(true,chave==='especialidades'?'faltometro':'atendimentos');
        }
    }
    function removerItemGeral(i,chave) {
        if (dadosGerais.unidade[chave]?.[i] !== undefined) {
            dadosGerais.unidade[chave].splice(i,1);
            mostrarSecao('sms');
            salvarDados(true,'sms');
        }
    }
    function adicionarItem(chave,subChave) {
        if (!dadosUnidade.unidade[chave]) dadosUnidade.unidade[chave]=[];
        dadosUnidade.unidade[chave].push({nome:'Novo Item',[subChave]:0});
        mostrarSecao(chave==='especialidades'?'faltometro':'atendimentos');
        salvarDados(true,chave==='especialidades'?'faltometro':'atendimentos');
    }
    function adicionarItemGeral(chave,subChave) {
        if (!dadosGerais.unidade[chave]) dadosGerais.unidade[chave]=[];
        dadosGerais.unidade[chave].push({nome:'Novo Item',[subChave]:0});
        mostrarSecao('sms');
        salvarDados(true,'sms');
    }
    function salvarDados(notify=false, tipo=null) {
        if (permissoesUsuario?.nivel==='visualizador') { mostrarNotificacao('Apenas visualiza√ß√£o.','error'); return; }
        const ts = Date.now();
        dadosUnidade.ultima_atualizacao = ts;

        // Grava apenas o campo alterado (economiza writes e bandwidth)
        const camposPorTipo = {
            'unidade':       { 'unidade/nome': dadosUnidade.unidade.nome },
            'faltometro':    { 'unidade/especialidades': dadosUnidade.unidade.especialidades },
            'atendimentos':  { 'unidade/atendimentos': dadosUnidade.unidade.atendimentos },
            'avisos':        { 'avisos': dadosUnidade.avisos },
            'video':         { 'unidade/videoUrls': dadosGerais.unidade.videoUrls },
            'sms':           { 'unidade/smsMunicipal': dadosGerais.unidade.smsMunicipal },
        };

        if (tipo && camposPorTipo[tipo]) {
            // Escrita cir√∫rgica: s√≥ o campo necess√°rio
            const campos = camposPorTipo[tipo];
            const ref = (tipo === 'video' || tipo === 'sms')
                ? db.ref('paineis/geral')
                : db.ref('paineis/' + unidadeID);
            ref.update({ ...campos, ultima_atualizacao: ts });
        } else {
            // Fallback: grava tudo (apenas quando tipo n√£o especificado)
            db.ref('paineis/' + unidadeID).set(dadosUnidade);
            if (isMatriz) db.ref('paineis/geral').set(dadosGerais);
        }

        if (notify) mostrarNotificacao('Dados salvos!','success');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // USU√ÅRIOS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // garantirAdminNoFirebase() j√° definida no bloco de autentica√ß√£o acima

    function carregarTodosUsuarios() {
        db.ref('usuarios').once('value').then(snap => {
            listaUsuarios = Object.entries(snap.val()||{}).map(([k,d])=>({id:k,...d}));
        });
    }

    function carregarTodasUnidades() {
        db.ref('paineis').once('value').then(snap => {
            listaTodasUnidades = Object.entries(snap.val()||{})
                .filter(([k])=>k!=='geral')
                .map(([k,d])=>({
                    id:k, nome:d.unidade?.nome||`Unidade ${k}`,
                    especialidades:d.unidade?.especialidades?.length||0,
                    atendimentos:d.unidade?.atendimentos?.length||0,
                    avisos:d.avisos?.length||0,
                    ultima_atualizacao:d.ultima_atualizacao||0
                }));
        });
    }

    function mostrarGerenciamentoUsuarios() {
        let rows = listaUsuarios.length===0
            ? `<tr><td colspan="6" style="text-align:center;padding:40px;color:#94a3b8;"><i class="fas fa-users" style="font-size:28px;display:block;margin-bottom:10px;"></i>Nenhum usu√°rio</td></tr>`
            : listaUsuarios.map(u => {
                const nb = u.nivel==='super_admin' ? `<span class="badge badge-red">Super Admin</span>`
                         : u.nivel==='admin_unidade' ? `<span class="badge badge-blue">Admin</span>`
                         : `<span class="badge badge-amber">Visualizador</span>`;
                const sb = u.status==='ativo' ? `<span class="badge badge-green"><i class="fas fa-circle" style="font-size:8px;"></i> Ativo</span>` : `<span class="badge badge-red">Inativo</span>`;
                const unids = u.unidades_permitidas?.includes('todas') ? 'Todas' : (u.unidades_permitidas||[]).join(', ') || '‚Äî';
                return `<tr>
                    <td><strong>${u.nome||'‚Äî'}</strong></td>
                    <td><code>${u.login}</code></td>
                    <td>${nb}</td>
                    <td style="font-size:12px;color:#64748b;">${unids}</td>
                    <td>${sb}</td>
                    <td>
                        <div style="display:flex;gap:6px;">
                            <button class="btn btn-ghost" style="height:32px;padding:0 12px;font-size:12px;" onclick="editarUsuario('${u.id}')"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger" style="height:32px;padding:0 12px;font-size:12px;" onclick="excluirUsuario('${u.id}','${u.nome}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>`;
            }).join('');

        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>Gerenciar Usu√°rios</h2>
                <p>Controle de acesso ao painel administrativo.</p>
            </div>
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h3 style="margin:0;border:none;padding:0;"><span class="card-icon"><i class="fas fa-users"></i></span> Usu√°rios (${listaUsuarios.length})</h3>
                    <button class="btn btn-primary" onclick="adicionarNovoUsuario()"><i class="fas fa-user-plus"></i> Novo Usu√°rio</button>
                </div>
                <table class="data-table">
                    <thead><tr><th>Nome</th><th>Login</th><th>N√≠vel</th><th>Unidades</th><th>Status</th><th>A√ß√µes</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>`;
    }

    function adicionarNovoUsuario() {
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header"><h2>Novo Usu√°rio</h2><p>Preencha os dados do novo usu√°rio.</p></div>
            <div class="card" style="max-width:560px;">
                <h3><span class="card-icon"><i class="fas fa-user-plus"></i></span> Dados</h3>
                <label class="form-label">Nome Completo</label>
                <input id="nuNome" class="form-input" placeholder="Nome" style="margin-bottom:14px;">
                <label class="form-label">Login</label>
                <input id="nuLogin" class="form-input" placeholder="login" style="margin-bottom:14px;">
                <label class="form-label">Senha</label>
                <input id="nuSenha" type="password" class="form-input" placeholder="Senha" style="margin-bottom:14px;">
                <label class="form-label">N√≠vel de Acesso</label>
                <select id="nuNivel" class="form-input" style="margin-bottom:14px;">
                    <option value="super_admin">Super Administrador</option>
                    <option value="admin_unidade" selected>Administrador de Unidade</option>
                    <option value="visualizador">Visualizador</option>
                </select>
                <label class="form-label">Unidades Permitidas</label>
                <div style="background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:9px;padding:16px;margin-bottom:14px;">
                    <label style="display:flex;align-items:center;gap:10px;margin-bottom:12px;font-weight:600;font-size:13px;">
                        <input type="checkbox" id="nuTodas" onchange="document.querySelectorAll('.nuCheck').forEach(c=>c.checked=this.checked)">
                        Todas as unidades
                    </label>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
                        ${listaTodasUnidades.map(u=>`<label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#475569;">
                            <input type="checkbox" class="nuCheck" value="${u.id}"> ${u.nome}
                        </label>`).join('')}
                    </div>
                </div>
                <label class="form-label">Status</label>
                <select id="nuStatus" class="form-input" style="margin-bottom:24px;">
                    <option value="ativo">Ativo</option><option value="inativo">Inativo</option>
                </select>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-primary" onclick="salvarNovoUsuario()"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn btn-ghost" onclick="mostrarSecao('usuarios')"><i class="fas fa-times"></i> Cancelar</button>
                </div>
            </div>`;
    }

    function salvarNovoUsuario() {
        const nome=document.getElementById('nuNome').value.trim();
        const login=document.getElementById('nuLogin').value.trim();
        const senha=document.getElementById('nuSenha').value;
        const nivel=document.getElementById('nuNivel').value;
        const status=document.getElementById('nuStatus').value;
        if (!nome||!login||!senha) { mostrarNotificacao('Preencha todos os campos!','error'); return; }
        if (listaUsuarios.find(u=>u.login===login)) { mostrarNotificacao('Login j√° em uso!','error'); return; }
        let unidades = document.getElementById('nuTodas').checked ? ['todas']
            : [...document.querySelectorAll('.nuCheck:checked')].map(c=>c.value);
        const key = 'user_'+Date.now()+'_'+Math.random().toString(36).substr(2,6);
        db.ref('usuarios/'+key).set({ nome,login,senha,nivel,unidades_permitidas:unidades,status,data_criacao:new Date().toISOString(),criado_por:usuarioAtual.nome||'admin' })
            .then(()=>{ mostrarNotificacao('Usu√°rio criado!','success'); carregarTodosUsuarios(); setTimeout(()=>mostrarSecao('usuarios'),800); });
    }

    function editarUsuario(uid) {
        const u = listaUsuarios.find(x=>x.id===uid);
        if (!u) return;
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header"><h2>Editar Usu√°rio</h2><p>${u.nome}</p></div>
            <div class="card" style="max-width:560px;">
                <h3><span class="card-icon"><i class="fas fa-user-edit"></i></span> Dados</h3>
                <label class="form-label">Nome</label>
                <input id="euNome" class="form-input" value="${u.nome||''}" style="margin-bottom:14px;">
                <label class="form-label">Login</label>
                <input id="euLogin" class="form-input" value="${u.login||''}" style="margin-bottom:14px;">
                <label class="form-label">Nova Senha (deixe em branco para n√£o alterar)</label>
                <input id="euSenha" type="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="margin-bottom:14px;">
                <label class="form-label">N√≠vel</label>
                <select id="euNivel" class="form-input" style="margin-bottom:14px;">
                    <option value="super_admin" ${u.nivel==='super_admin'?'selected':''}>Super Admin</option>
                    <option value="admin_unidade" ${u.nivel==='admin_unidade'?'selected':''}>Admin Unidade</option>
                    <option value="visualizador" ${u.nivel==='visualizador'?'selected':''}>Visualizador</option>
                </select>
                <label class="form-label">Unidades</label>
                <div style="background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:9px;padding:16px;margin-bottom:14px;">
                    <label style="display:flex;align-items:center;gap:10px;margin-bottom:12px;font-weight:600;font-size:13px;">
                        <input type="checkbox" id="euTodas" ${(u.unidades_permitidas||[]).includes('todas')?'checked':''}> Todas as unidades
                    </label>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
                        ${listaTodasUnidades.map(un=>{
                            const chk=(u.unidades_permitidas||[]).includes('todas')||(u.unidades_permitidas||[]).includes(un.id);
                            return `<label style="display:flex;align-items:center;gap:8px;font-size:13px;color:#475569;">
                                <input type="checkbox" class="euCheck" value="${un.id}" ${chk?'checked':''}> ${un.nome}
                            </label>`;
                        }).join('')}
                    </div>
                </div>
                <label class="form-label">Status</label>
                <select id="euStatus" class="form-input" style="margin-bottom:24px;">
                    <option value="ativo" ${u.status==='ativo'?'selected':''}>Ativo</option>
                    <option value="inativo" ${u.status==='inativo'?'selected':''}>Inativo</option>
                </select>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-primary" onclick="salvarEdicaoUsuario('${uid}')"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn btn-ghost" onclick="mostrarSecao('usuarios')"><i class="fas fa-times"></i> Cancelar</button>
                </div>
            </div>`;
    }

    function salvarEdicaoUsuario(uid) {
        const nome=document.getElementById('euNome').value.trim();
        const login=document.getElementById('euLogin').value.trim();
        const novaSenha=document.getElementById('euSenha').value;
        const nivel=document.getElementById('euNivel').value;
        const status=document.getElementById('euStatus').value;
        if (!nome||!login) { mostrarNotificacao('Preencha os campos obrigat√≥rios!','error'); return; }
        if (listaUsuarios.find(u=>u.login===login&&u.id!==uid)) { mostrarNotificacao('Login j√° em uso!','error'); return; }
        let unidades = document.getElementById('euTodas').checked ? ['todas']
            : [...document.querySelectorAll('.euCheck:checked')].map(c=>c.value);
        db.ref('usuarios/'+uid).once('value').then(snap=>{
            const cur=snap.val()||{};
            const upd = {nome,login,nivel,unidades_permitidas:unidades,status,senha:novaSenha||cur.senha,
                data_criacao:cur.data_criacao,criado_por:cur.criado_por,data_atualizacao:new Date().toISOString()};
            db.ref('usuarios/'+uid).set(upd).then(()=>{
                mostrarNotificacao('Usu√°rio atualizado!','success');
                carregarTodosUsuarios();
                setTimeout(()=>mostrarSecao('usuarios'),800);
            });
        });
    }

    function excluirUsuario(uid, nome) {
        if (uid==='admin_gti') { mostrarNotificacao('N√£o √© poss√≠vel excluir o admin principal!','error'); return; }
        if (confirm(`Excluir usu√°rio "${nome}"?`)) {
            db.ref('usuarios/'+uid).remove().then(()=>{
                mostrarNotificacao('Usu√°rio exclu√≠do!','success');
                carregarTodosUsuarios();
                setTimeout(()=>mostrarSecao('usuarios'),800);
            });
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UNIDADES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function mostrarTodasUnidades() {
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>Gerenciar Unidades</h2>
                <p>${listaTodasUnidades.length} unidade(s) cadastrada(s).</p>
            </div>
            <div style="display:flex;justify-content:flex-end;gap:10px;margin-bottom:20px;">
                <button class="btn btn-ghost" onclick="atualizarListaUnidades()"><i class="fas fa-sync-alt"></i> Atualizar</button>
                <button class="btn btn-primary" onclick="adicionarNovaUnidade()"><i class="fas fa-plus"></i> Nova Unidade</button>
            </div>
            <div class="units-grid">
                ${listaTodasUnidades.length===0 ? `
                    <div style="grid-column:1/-1;text-align:center;padding:60px;background:white;border-radius:14px;border:1px solid #e2e8f0;color:#94a3b8;">
                        <i class="fas fa-hospital" style="font-size:40px;display:block;margin-bottom:12px;opacity:0.4;"></i>
                        <p>Nenhuma unidade cadastrada</p>
                    </div>`
                : listaTodasUnidades.map(u => {
                    const ua = u.ultima_atualizacao ? new Date(u.ultima_atualizacao).toLocaleString('pt-BR') : 'Nunca';
                    return `<div class="unit-card">
                        <div class="unit-card-header">
                            <div>
                                <div class="unit-card-name">${u.nome}</div>
                                <div class="unit-card-id">ID: ${u.id}</div>
                            </div>
                        </div>
                        <div class="unit-stats">
                            <div class="unit-stat"><div class="unit-stat-val">${u.especialidades}</div><div class="unit-stat-lbl">Esp.</div></div>
                            <div class="unit-stat"><div class="unit-stat-val">${u.atendimentos}</div><div class="unit-stat-lbl">Atend.</div></div>
                            <div class="unit-stat"><div class="unit-stat-val">${u.avisos}</div><div class="unit-stat-lbl">Avisos</div></div>
                        </div>
                        <div style="font-size:11px;color:#94a3b8;margin-bottom:14px;"><i class="fas fa-clock"></i> ${ua}</div>
                        <div class="unit-actions">
                            <button class="unit-btn unit-btn-primary" onclick="acessarUnidade('${u.id}')"><i class="fas fa-external-link-alt"></i> Acessar</button>
                            <button class="unit-btn unit-btn-ghost" onclick="editarUnidade('${u.id}')"><i class="fas fa-cog"></i></button>
                            <button class="unit-btn unit-btn-danger" onclick="excluirUnidadeCard('${u.id}','${u.nome}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>`;
                }).join('')}
            </div>`;
    }

    function atualizarListaUnidades() { carregarTodasUnidades(); setTimeout(()=>{mostrarTodasUnidades();mostrarNotificacao('Atualizado!','success');},600); }
    function acessarUnidade(id) { window.open(`${location.origin}${location.pathname}?id=${id}`,'_blank'); }

    function adicionarNovaUnidade() {
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header"><h2>Nova Unidade</h2></div>
            <div class="card" style="max-width:480px;">
                <h3><span class="card-icon"><i class="fas fa-hospital"></i></span> Dados</h3>
                <label class="form-label">Nome da Unidade</label>
                <input id="nuNome2" class="form-input" placeholder="Nome" style="margin-bottom:14px;">
                <label class="form-label">ID √önico (letras, n√∫meros, underscore)</label>
                <input id="nuId2" class="form-input" placeholder="ex: ubs_norte" style="margin-bottom:24px;">
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-primary" onclick="criarNovaUnidade()"><i class="fas fa-save"></i> Criar</button>
                    <button class="btn btn-ghost" onclick="mostrarSecao('unidades')"><i class="fas fa-times"></i> Cancelar</button>
                </div>
            </div>`;
    }

    function criarNovaUnidade() {
        const nome=document.getElementById('nuNome2').value.trim();
        const id=document.getElementById('nuId2').value.trim().toLowerCase();
        if (!nome||!id) { mostrarNotificacao('Preencha todos os campos!','error'); return; }
        if (!/^[a-z0-9_]+$/.test(id)) { mostrarNotificacao('ID: apenas letras min√∫sculas, n√∫meros e underscore.','error'); return; }
        if (listaTodasUnidades.find(u=>u.id===id)) { mostrarNotificacao('ID j√° em uso!','error'); return; }
        db.ref('paineis/'+id).once('value').then(snap=>{
            if (snap.exists()) { mostrarNotificacao('Unidade j√° existe!','error'); return; }
            db.ref('paineis/'+id).set({
                unidade:{nome,especialidades:[],atendimentos:[]},
                avisos:[], flayers:[], ultima_atualizacao:Date.now(), data_criacao:new Date().toISOString()
            }).then(()=>{
                mostrarNotificacao(`Unidade "${nome}" criada!`,'success');
                carregarTodasUnidades();
                setTimeout(()=>mostrarSecao('unidades'),800);
            });
        });
    }

    function editarUnidade(uid) {
        const u = listaTodasUnidades.find(x=>x.id===uid);
        if (!u) return;
        document.getElementById('adminContent').innerHTML = `
            <div class="page-header"><h2>Editar Unidade</h2><p>ID: ${uid}</p></div>
            <div class="card" style="max-width:480px;">
                <h3><span class="card-icon"><i class="fas fa-edit"></i></span> Dados</h3>
                <label class="form-label">Nome</label>
                <input id="euNome2" class="form-input" value="${u.nome}" style="margin-bottom:24px;">
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-primary" onclick="salvarEdicaoUnidade('${uid}')"><i class="fas fa-save"></i> Salvar</button>
                    <button class="btn btn-ghost" onclick="mostrarSecao('unidades')"><i class="fas fa-times"></i> Cancelar</button>
                    <button class="btn btn-danger" onclick="excluirUnidade('${uid}','${u.nome}')"><i class="fas fa-trash"></i> Excluir</button>
                </div>
            </div>`;
    }

    function salvarEdicaoUnidade(uid) {
        const nome=document.getElementById('euNome2').value.trim();
        if (!nome) { mostrarNotificacao('Digite um nome!','error'); return; }
        db.ref('paineis/'+uid+'/unidade/nome').set(nome).then(()=>{
            mostrarNotificacao('Unidade atualizada!','success');
            carregarTodasUnidades();
            setTimeout(()=>mostrarSecao('unidades'),800);
        });
    }

    function excluirUnidade(uid, nome) {
        if (uid==='geral') { mostrarNotificacao('N√£o √© poss√≠vel excluir a Matriz!','error'); return; }
        if (confirm(`Excluir unidade "${nome}" permanentemente?`)) {
            db.ref('paineis/'+uid).remove().then(()=>{
                mostrarNotificacao('Unidade exclu√≠da!','success');
                carregarTodasUnidades();
                setTimeout(()=>mostrarSecao('unidades'),800);
            });
        }
    }

    function excluirUnidadeCard(uid, nome) { excluirUnidade(uid, nome); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MONITOR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function mostrarMonitorInatividade() {
        if (!listaTodasUnidades.length) { carregarTodasUnidades(); setTimeout(mostrarMonitorInatividade,1000); return; }
        const agora=Date.now();
        const data = listaTodasUnidades.map(u=>{
            const h = u.ultima_atualizacao ? Math.floor((agora-u.ultima_atualizacao)/3600000) : 999;
            const s = h>168?{lbl:'Cr√≠tico',cls:'badge-red'}:h>72?{lbl:'Alerta',cls:'badge-amber'}:h>24?{lbl:'Aten√ß√£o',cls:'badge-amber'}:{lbl:'Ativo',cls:'badge-green'};
            const t = h===0?'< 1h':h<24?`${h}h`:`${Math.floor(h/24)}d ${h%24}h`;
            return {...u,h,s,t,ua:u.ultima_atualizacao?new Date(u.ultima_atualizacao).toLocaleString('pt-BR'):'Nunca'};
        }).sort((a,b)=>b.h-a.h);
        const cnt = ['badge-green','badge-amber','badge-amber','badge-red'].map(()=>0);
        const ativas=data.filter(u=>u.h<=24).length;
        const atencao=data.filter(u=>u.h>24&&u.h<=72).length;
        const alerta=data.filter(u=>u.h>72&&u.h<=168).length;
        const criticas=data.filter(u=>u.h>168).length;

        document.getElementById('adminContent').innerHTML = `
            <div class="page-header">
                <h2>Monitor de Inatividade</h2>
                <p>Unidades que n√£o atualizaram dados recentemente.</p>
            </div>
            <div class="stat-grid">
                <div class="stat-card" style="background:linear-gradient(135deg,#059669,#10b981);">
                    <div class="stat-card-val">${ativas}</div><div class="stat-card-lbl">Ativas (‚â§24h)</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg,#d97706,#f59e0b);">
                    <div class="stat-card-val">${atencao}</div><div class="stat-card-lbl">Aten√ß√£o (1‚Äì3d)</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg,#ea580c,#f97316);">
                    <div class="stat-card-val">${alerta}</div><div class="stat-card-lbl">Alerta (3‚Äì7d)</div>
                </div>
                <div class="stat-card" style="background:linear-gradient(135deg,#dc2626,#ef4444);">
                    <div class="stat-card-val">${criticas}</div><div class="stat-card-lbl">Cr√≠ticas (>7d)</div>
                </div>
            </div>
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h3 style="margin:0;border:none;padding:0;"><span class="card-icon"><i class="fas fa-satellite-dish"></i></span> Detalhamento (${data.length})</h3>
                    <button class="btn btn-ghost" onclick="atualizarMonitor()"><i class="fas fa-sync-alt"></i> Atualizar</button>
                </div>
                <table class="data-table">
                    <thead><tr><th>Unidade</th><th>Status</th><th>Inativo h√°</th><th>√öltima Atualiza√ß√£o</th><th>Dados</th><th>A√ß√£o</th></tr></thead>
                    <tbody>
                        ${data.map(u=>`<tr>
                            <td><strong>${u.nome}</strong><div style="font-size:11px;color:#94a3b8;font-family:'JetBrains Mono',monospace;">${u.id}</div></td>
                            <td><span class="badge ${u.s.cls}">${u.s.lbl}</span></td>
                            <td style="font-family:'JetBrains Mono',monospace;font-weight:600;">${u.t}</td>
                            <td style="font-size:13px;color:#64748b;">${u.ua}</td>
                            <td>
                                <div style="display:flex;gap:12px;">
                                    <div style="text-align:center;"><div style="font-weight:700;color:#ef4444;">${u.especialidades}</div><div style="font-size:10px;color:#94a3b8;">Esp.</div></div>
                                    <div style="text-align:center;"><div style="font-weight:700;color:#3b82f6;">${u.atendimentos}</div><div style="font-size:10px;color:#94a3b8;">Atend.</div></div>
                                    <div style="text-align:center;"><div style="font-weight:700;color:#8b5cf6;">${u.avisos}</div><div style="font-size:10px;color:#94a3b8;">Avisos</div></div>
                                </div>
                            </td>
                            <td><button class="btn btn-ghost" style="height:32px;font-size:12px;" onclick="acessarUnidade('${u.id}')"><i class="fas fa-external-link-alt"></i></button></td>
                        </tr>`).join('')}
                    </tbody>
                </table>
            </div>`;
    }

    function atualizarMonitor() { carregarTodasUnidades(); setTimeout(()=>{mostrarMonitorInatividade();mostrarNotificacao('Monitor atualizado!','success');},1000); }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // NOTIFICA√á√ïES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function mostrarNotificacao(msg, tipo='info') {
        const n = document.createElement('div');
        n.className = `notif notif-${tipo}`;
        const icons = {success:'check-circle',error:'exclamation-circle',warning:'exclamation-triangle',info:'info-circle'};
        n.innerHTML = `<i class="fas fa-${icons[tipo]||'info-circle'}"></i> ${msg}`;
        document.body.appendChild(n);
        setTimeout(() => { n.style.animation='slideOutNotif 0.3s ease-out forwards'; setTimeout(()=>n.remove(),300); }, 4000);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    window.onload = iniciarSistema;
    </script>
</body>
</html>
