<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Saúde - Passo Fundo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>

    <style>
        /* [MANTENHA TODOS OS ESTILOS ORIGINAIS AQUI] */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Segoe UI', sans-serif; }
        html, body { width: 1920px; height: 1080px; overflow: hidden; position: fixed; top: 0; left: 0; }
        body { background: linear-gradient(135deg, #0a1929 0%, #1a2332 50%, #0f1b2d 100%); color: white; }
        .footer-line { position: fixed; bottom: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, transparent 0%, #00e676 20%, #00ff88 50%, #00e676 80%, transparent 100%); z-index: 100; }
        .admin-gear { position: fixed; top: 10px; right: 10px; width: 35px; height: 35px; background: transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 2000; opacity: 0.15; transition: opacity 0.3s; }
        .admin-gear:hover { opacity: 0.8; }
        .admin-gear i { color: rgba(255, 255, 255, 0.5); font-size: 20px; }
        .main-header { background: linear-gradient(135deg, #1565c0 0%, #1976d2 50%, #1e88e5 100%); padding: 8px 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 4px solid #00e676; height: 75px; width: 100%; position: fixed; top: 0; left: 0; z-index: 100; }
        .header-time { font-size: 42px; font-weight: bold; color: #00e676; font-family: 'Courier New', monospace; }
        .main-container { position: fixed; top: 75px; left: 0; width: 100%; height: calc(100% - 79px); display: grid; grid-template-columns: 75% 25%; gap: 12px; padding: 12px; }
        .left-column { display: flex; flex-direction: column; gap: 8px; }
        .video-section { background: #000; border-radius: 16px; overflow: hidden; flex: 4; border: 2px solid rgba(0, 230, 118, 0.3); position: relative; }
        .video-container { width: 100%; height: 100%; }
        .video-iframe { width: 100%; height: 100%; border: none; }
        .btn-som { position: absolute; bottom: 20px; left: 20px; z-index: 101; background: rgba(0, 230, 118, 0.9); color: white; border: none; padding: 12px 24px; border-radius: 30px; cursor: pointer; font-weight: bold; }
        .right-column { background: rgba(13, 27, 42, 0.8); border-radius: 16px; padding: 15px; border: 2px solid rgba(255, 82, 82, 0.3); overflow: hidden; }
        .carousel-container { height: 100%; position: relative; }
        .carousel-item { position: absolute; width: 100%; height: 100%; opacity: 0; display: flex; flex-direction: column; transition: opacity 0.5s ease-in-out; }
        .carousel-item.active { opacity: 1; }
        .section-title { font-size: 28px; font-weight: 800; color: #00e676; text-align: center; margin-bottom: 10px; text-transform: uppercase; border-bottom: 3px solid rgba(0, 230, 118, 0.3); }
        .atendimentos-title { color: #2196f3; border-bottom-color: rgba(33, 150, 243, 0.3); }
        .sms-title { color: #ba68c8; border-bottom-color: rgba(186, 104, 200, 0.3); }
        .total-container { border-radius: 12px; padding: 10px; text-align: center; margin-bottom: 10px; border: 2px solid rgba(255, 255, 255, 0.2); background: linear-gradient(135deg, #d32f2f, #f44336); }
        .total-atendimentos { background: linear-gradient(135deg, #1976d2, #2196f3); }
        .total-sms { background: linear-gradient(135deg, #7b1fa2, #9c27b0); }
        .total-value { font-size: 50px; font-weight: 900; font-family: 'Courier New', monospace; }
        .lista-container { flex: 1; display: flex; flex-direction: column; gap: 4px; justify-content: flex-start; overflow: hidden; }
        .item-lista { background: rgba(255, 255, 255, 0.08); border-radius: 6px; padding: 4px 12px; display: flex; justify-content: space-between; align-items: center; flex: 1 1 auto; min-height: 0; max-height: 70px; }
        .item-nome { font-size: 18px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-valor { font-size: 38px; font-weight: 800; font-family: 'Courier New', monospace; }
        .announcements-section { background: rgba(33, 150, 243, 0.15); border-radius: 16px; padding: 12px; height: 110px; border: 2px solid rgba(33, 150, 243, 0.3); position: relative; overflow: hidden; }
        .ticker-item { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; font-size: 29px; font-weight: 600; opacity: 0; padding: 0 20px; border-left: 5px solid #2196f3; }
        .ticker-item.active { animation: slideInOut 30s ease-in-out forwards; }
        @keyframes slideInOut { 0% { transform: translateX(100%); opacity: 0; } 4% { transform: translateX(0); opacity: 1; } 96% { transform: translateX(0); opacity: 1; } 100% { transform: translateX(-100%); opacity: 0; } }

        /* ADMIN - REDESIGN PROFISSIONAL */
        #loginScreen, #adminPanel { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.95); 
            z-index: 3000; 
            justify-content: center; 
            align-items: center; 
        }
        
        #adminPanel { 
            background: #f8f9fa; 
            color: #333; 
            flex-direction: column; 
        }
        
        .admin-header { 
            background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%); 
            color: white; 
            padding: 18px 30px; 
            width: 100%; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
            position: relative;
            z-index: 10;
        }
        
        .admin-header h1 {
            font-size: 22px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .admin-header h1 i {
            color: #00e676;
        }
        
        .admin-container { 
            display: grid; 
            grid-template-columns: 320px 1fr; 
            width: 100%; 
            height: calc(100% - 70px); 
        }
        
        .admin-sidebar { 
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%); 
            border-right: 1px solid #e0e0e0; 
            padding: 25px 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }
        
        .sidebar-item { 
            padding: 16px 30px; 
            cursor: pointer; 
            font-weight: 500; 
            border-bottom: 1px solid #f0f0f0; 
            color: #555;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-item i {
            width: 20px;
            color: #666;
            font-size: 16px;
        }
        
        .sidebar-item:hover { 
            background: #e3f2fd; 
            color: #1565c0;
            padding-left: 35px;
        }
        
        .sidebar-item:hover i {
            color: #1565c0;
        }
        
        .sidebar-item.active { 
            background: linear-gradient(90deg, #1565c0 0%, #1976d2 100%); 
            color: white; 
            font-weight: 600;
            box-shadow: inset 4px 0 0 #00e676;
        }
        
        .sidebar-item.active i {
            color: white;
        }
        
        .admin-content { 
            padding: 35px 40px; 
            overflow-y: auto; 
            background: #ffffff;
        }
        
        .admin-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #e8e8e8;
        }
        
        .admin-section h2 {
            color: #1565c0;
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .admin-section h2 i {
            color: #00e676;
        }
        
        .section-info {
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #1565c0;
            font-size: 14px;
            color: #555;
        }
        
        .admin-input { 
            width: 100%; 
            padding: 14px 18px; 
            margin: 10px 0; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }
        
        .admin-input:focus { 
            outline: none; 
            border-color: #1565c0; 
            box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
        }
        
        textarea.admin-input {
            min-height: 150px;
            resize: vertical;
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
        }
        
        .admin-btn { 
            padding: 14px 28px; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: 600; 
            background: linear-gradient(135deg, #00e676 0%, #00c853 100%); 
            color: white; 
            font-size: 15px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0, 230, 118, 0.3);
        }
        
        .admin-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(0, 230, 118, 0.4);
        }
        
        .admin-btn-danger {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            box-shadow: 0 4px 10px rgba(244, 67, 54, 0.3);
        }
        
        .admin-btn-secondary {
            background: linear-gradient(135deg, #757575 0%, #616161 100%);
            box-shadow: 0 4px 10px rgba(117, 117, 117, 0.3);
        }
        
        .admin-btn-primary {
            background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%);
            box-shadow: 0 4px 10px rgba(21, 101, 192, 0.3);
        }
        
        .log-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            background: white; 
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .log-table th { 
            padding: 18px 20px; 
            text-align: left; 
            background: linear-gradient(135deg, #1565c0 0%, #1976d2 100%);
            color: white;
            font-weight: 600;
            font-size: 15px;
        }
        
        .log-table td { 
            padding: 16px 20px; 
            text-align: left; 
            border-bottom: 1px solid #f0f0f0;
            color: #555;
        }
        
        .log-table tr:hover td {
            background: #f5f9ff;
        }
        
        .log-table tr:last-child td {
            border-bottom: none;
        }
        
        .status-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-active {
            background: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-inactive {
            background: #ffebee;
            color: #c62828;
        }
        
        .login-box {
            background: white;
            padding: 45px;
            border-radius: 16px;
            width: 450px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
        }
        
        .login-box h2 {
            color: #1565c0;
            margin-bottom: 10px;
            font-size: 24px;
            font-weight: 600;
        }
        
        .login-box p {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .login-icon {
            font-size: 48px;
            color: #1565c0;
            margin-bottom: 20px;
        }
        
        .version-info {
            position: fixed;
            bottom: 20px;
            right: 20px;
            color: #999;
            font-size: 12px;
        }
        
        /* Sistema de login Google */
        .google-btn {
            background: #4285F4;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            transition: all 0.3s;
        }
        
        .google-btn:hover {
            background: #3367D6;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #1565c0;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f5f9ff;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-email {
            font-size: 12px;
            color: #666;
        }
        
        .logout-btn {
            background: none;
            border: 1px solid #ddd;
            color: #666;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .logout-btn:hover {
            background: #ffebee;
            color: #d32f2f;
            border-color: #ffcdd2;
        }
        
        /* Botão de backup rápido */
        #botaoBackupRapido {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(46, 125, 50, 0.8);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 9999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.3s;
            opacity: 0.7;
            font-size: 18px;
            display: none;
        }
        
        #botaoBackupRapido:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        #botaoBackupRapido:hover::after {
            content: "Backup Rápido";
            position: absolute;
            left: 45px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Notificações */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 99999;
            animation: slideInRight 0.3s, fadeOut 0.3s 4.7s;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #00c853, #00e676);
            border-left: 5px solid #00b248;
        }
        
        .notification.error {
            background: linear-gradient(135deg, #d32f2f, #f44336);
            border-left: 5px solid #b71c1c;
        }
        
        .notification.info {
            background: linear-gradient(135deg, #1565c0, #1976d2);
            border-left: 5px solid #0d47a1;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        /* Sistema de backup */
        .status-monitor {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .status-card {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .status-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .status-card h3 {
            font-size: 16px;
            color: #555;
            margin-bottom: 10px;
        }
        
        .status-count {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 10px;
        }
        
        .status-desc {
            font-size: 12px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="footer-line"></div>
    <div class="admin-gear" onclick="openLogin()"><i class="fas fa-cog"></i></div>

    <header class="main-header">
        <div class="header-text">
            <h1 id="mainTitle">Secretaria Municipal de Saúde</h1>
            <div style="font-size: 22px; opacity: 0.95;" id="headerSubtitle">Carregando...</div>
        </div>
        <div class="datetime-container">
            <div id="currentDate" style="font-size: 14px; text-align: right;"></div>
            <div id="currentTime" class="header-time"></div>
        </div>
    </header>

    <main class="main-container">
        <div class="left-column">
            <section class="video-section">
                <button id="btnSom" class="btn-som" onclick="ativarSom()"><i class="fas fa-volume-up"></i> ATIVAR SOM</button>
                <div class="video-container" id="videoContainer"></div>
            </section>
            <section class="announcements-section" id="tickerContainer"></section>
        </div>
        <div class="right-column">
            <div class="carousel-container" id="carouselContainer">
                <div class="carousel-item active" id="itemFaltometro"></div>
                <div class="carousel-item" id="itemAtendimentos"></div>
                <div class="carousel-item" id="itemSMS"></div>
            </div>
        </div>
    </main>

    <!-- Tela de Login -->
    <div id="loginScreen"></div>

    <!-- Painel Administrativo -->
    <div id="adminPanel">
        <div class="admin-header">
            <h1>
                <i class="fas fa-sliders-h"></i>
                <span id="adminIdTitle">Painel Administrativo</span>
                <span style="font-size: 14px; opacity: 0.9; font-weight: normal;">
                    | Unidade: <span id="adminUnidadeNome"></span>
                    | Usuário: <span id="adminUserName"></span>
                </span>
            </h1>
            <div>
                <div id="userSessionInfo" style="display: inline-flex; align-items: center; margin-right: 15px;"></div>
                <button class="admin-btn admin-btn-secondary" onclick="salvarDados(); mostrarNotificacao('Dados salvos com sucesso!', 'success')" style="margin-right: 10px;">
                    <i class="fas fa-save"></i> Salvar
                </button>
                <button class="admin-btn admin-btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </div>
        <div class="admin-container">
            <div class="admin-sidebar" id="sidebar">
                <div class="sidebar-item active" onclick="mostrarSecao('unidade')">
                    <i class="fas fa-hospital"></i> Identificação da Unidade
                </div>
                <div class="sidebar-item" id="menuFalto" onclick="mostrarSecao('faltometro')">
                    <i class="fas fa-calendar-times"></i> Faltômetro
                </div>
                <div class="sidebar-item" id="menuAtend" onclick="mostrarSecao('atendimentos')">
                    <i class="fas fa-user-md"></i> Atendimentos da Unidade
                </div>
                <div class="sidebar-item" id="menuSMS" onclick="mostrarSecao('sms')" style="display: none;">
                    <i class="fas fa-city"></i> Produção Municipal
                </div>
                <div class="sidebar-item" onclick="mostrarSecao('avisos')">
                    <i class="fas fa-bullhorn"></i> Avisos
                </div>
                <div class="sidebar-item" id="menuVideo" onclick="mostrarSecao('video')" style="display: none;">
                    <i class="fas fa-video"></i> Vídeos
                </div>
                <div class="sidebar-item" id="menuUnidades" style="background: #e3f2fd; color: #1565c0; display:none" onclick="mostrarSecao('unidades')">
                    <i class="fas fa-building"></i> Gerenciar Unidades
                </div>
                <div class="sidebar-item" id="menuUsuarios" style="background: #e8f5e9; color: #2e7d32; display:none" onclick="mostrarSecao('usuarios')">
                    <i class="fas fa-users-cog"></i> Gerenciar Usuários
                </div>
                <div class="sidebar-item" id="menuBackup" style="background: #e3f2fd; color: #1565c0; display:none" onclick="mostrarSecao('backup')">
                    <i class="fas fa-database"></i> Sistema de Backup
                </div>
            </div>
            <div class="admin-content" id="adminContent"></div>
        </div>
        <div class="version-info">
            Sistema de Saúde PMPF v2.0 | Login com Google
        </div>
    </div>

    <!-- Botão de backup rápido (só aparece para matriz) -->
    <div id="botaoBackupRapido"></div>

    <script>
        // ============================================
        // CONFIGURAÇÃO DO FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyCEyebuGCoD8NYQJrIR1KpRRpkWijveN3A",
            authDomain: "gti-painel.firebaseapp.com",
            databaseURL: "https://gti-painel-default-rtdb.firebaseio.com",
            projectId: "gti-painel",
            storageBucket: "gti-painel.firebasestorage.app",
            messagingSenderId: "805155882010",
            appId: "1:805155882010:web:6fed70ecffb8f07eb9fda3",
            measurementId: "G-0T1FWSRNLW"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        
        const urlParams = new URLSearchParams(window.location.search);
        const unidadeID = urlParams.get('id') || 'geral';
        const isMatriz = (unidadeID === 'geral');
        
        let dadosUnidade = { unidade: { nome: "", especialidades: [], atendimentos: [] }, avisos: [] };
        let dadosGerais = { unidade: { videoUrls: [], smsMunicipal: [] }, avisos: [] };
        let logsAtualizacao = {};
        let todasUnidades = {};
        let usuarioLogado = null;
        
        let isMuted = true;
        let carouselIndex = 0;
        let tickerInterval = null;

        // ============================================
        // SISTEMA DE AUTENTICAÇÃO GOOGLE CORRIGIDO
        // ============================================

        // Inicializar sistema de autenticação
        async function inicializarSistemaAutenticacao() {
            try {
                // Verificar se há sessão ativa
                const sessao = verificarSessaoAtiva();
                if (sessao) {
                    usuarioLogado = sessao;
                    atualizarInterfaceUsuario();
                }
                
                // Configurar listener do auth state
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        // Usuário autenticado com Google
                        await processarUsuarioGoogle(user);
                    } else {
                        // Usuário não autenticado
                        usuarioLogado = null;
                    }
                });
                
            } catch (error) {
                console.error('[AUTH] Erro ao inicializar:', error);
            }
        }

        // Processar usuário autenticado com Google
        async function processarUsuarioGoogle(user) {
            try {
                const email = user.email;
                const nome = user.displayName || email.split('@')[0];
                
                // Verificar se é administrador GTI
                if (email === 'gti@pmpf.rs.gov.br') {
                    // Verificar se já existe no sistema
                    const snapshot = await db.ref('usuarios_autorizados/gti_pmpf_rs_gov_br').once('value');
                    if (!snapshot.exists()) {
                        // Criar administrador GTI padrão
                        await criarAdministradorGTI();
                    }
                    
                    usuarioLogado = {
                        email: email,
                        nome: 'Administrador GTI',
                        tipo: 'super_admin',
                        unidadeId: 'geral',
                        unidadeNome: 'Matriz',
                        dataLogin: new Date().toISOString(),
                        foto: user.photoURL
                    };
                    
                } else {
                    // Verificar se é usuário autorizado
                    const emailKey = email.replace(/[.#$/[\]]/g, '_');
                    const snapshot = await db.ref(`usuarios_autorizados/${emailKey}`).once('value');
                    const usuarioDB = snapshot.val();
                    
                    if (!usuarioDB || !usuarioDB.ativo) {
                        mostrarNotificacao('Acesso não autorizado. Contate o administrador.', 'error');
                        auth.signOut();
                        return;
                    }
                    
                    // Verificar permissões da unidade
                    if (usuarioDB.tipo === 'unidade' && usuarioDB.unidadeId !== unidadeID) {
                        mostrarNotificacao(`Você só tem acesso à unidade: ${usuarioDB.unidadeNome}`, 'error');
                        auth.signOut();
                        return;
                    }
                    
                    usuarioLogado = {
                        email: email,
                        nome: usuarioDB.nome || nome,
                        tipo: usuarioDB.tipo,
                        unidadeId: usuarioDB.unidadeId,
                        unidadeNome: usuarioDB.unidadeNome,
                        dataLogin: new Date().toISOString(),
                        foto: user.photoURL
                    };
                }
                
                // Salvar sessão
                salvarSessao(usuarioLogado);
                
                // Atualizar último acesso
                const emailKey = usuarioLogado.email.replace(/[.#$/[\]]/g, '_');
                await db.ref(`usuarios_autorizados/${emailKey}/ultimoAcesso`).set(new Date().toISOString());
                
                // Atualizar interface
                atualizarInterfaceUsuario();
                
                // Fechar tela de login e mostrar painel
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'flex';
                mostrarSecao('unidade');
                
                mostrarNotificacao(`Bem-vindo, ${usuarioLogado.nome}!`, 'success');
                
                // Registrar log de acesso
                registrarLogAcesso();
                
            } catch (error) {
                console.error('[AUTH] Erro ao processar usuário Google:', error);
                mostrarNotificacao('Erro ao processar login', 'error');
            }
        }

        // Criar administrador GTI padrão
        async function criarAdministradorGTI() {
            const adminData = {
                email: 'gti@pmpf.rs.gov.br',
                nome: 'Administrador GTI',
                tipo: 'super_admin',
                unidadeId: 'geral',
                unidadeNome: 'Matriz',
                dataAutorizacao: new Date().toISOString(),
                ativo: true,
                criadoPor: 'sistema',
                podeCriarAdmins: true,
                permissoes: ['tudo']
            };
            
            await db.ref('usuarios_autorizados/gti_pmpf_rs_gov_br').set(adminData);
            console.log('[AUTH] Administrador GTI criado com sucesso');
        }

        // Mostrar tela de login com Google
        function mostrarTelaLoginGoogle() {
            const loginScreen = document.getElementById('loginScreen');
            
            loginScreen.innerHTML = `
                <div class="login-box" style="width: 400px;">
                    <div class="login-icon">
                        <i class="fab fa-google" style="color: #4285F4;"></i>
                    </div>
                    <h2>Acesso ao Sistema</h2>
                    <p style="margin-bottom: 10px;">Use sua conta Google autorizada</p>
                    <p style="color: #666; font-size: 13px; margin-bottom: 30px;">
                        Sistema restrito aos funcionários da saúde
                    </p>
                    
                    <div style="margin: 30px 0;">
                        <button id="btnGoogleLogin" class="google-btn" onclick="loginComGoogle()">
                            <i class="fab fa-google"></i> Entrar com Google
                        </button>
                    </div>
                    
                    <div style="color: #666; font-size: 12px; margin-top: 20px;">
                        <i class="fas fa-info-circle"></i> Em caso de problemas, contate a GTI
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                        <small style="color: #888;">
                            Sistema de Saúde PMPF | Acesso restrito
                        </small>
                    </div>
                </div>
            `;
            
            loginScreen.style.display = 'flex';
        }

        // Login com Google
        function loginComGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.addScope('email');
            provider.addScope('profile');
            
            auth.signInWithPopup(provider).catch((error) => {
                console.error('[GOOGLE LOGIN] Erro:', error);
                mostrarNotificacao('Erro ao fazer login com Google', 'error');
            });
        }

        // Verificar sessão ativa
        function verificarSessaoAtiva() {
            try {
                const sessaoStr = localStorage.getItem('userSession');
                if (!sessaoStr) return null;
                
                const sessao = JSON.parse(sessaoStr);
                
                // Verificar expiração (8 horas)
                const expiracao = new Date(sessao.dataLogin).getTime() + (8 * 60 * 60 * 1000);
                if (Date.now() > expiracao) {
                    localStorage.removeItem('userSession');
                    auth.signOut();
                    return null;
                }
                
                return sessao;
            } catch (error) {
                return null;
            }
        }

        // Salvar sessão
        function salvarSessao(usuario) {
            localStorage.setItem('userSession', JSON.stringify(usuario));
        }

        // Atualizar interface do usuário
        function atualizarInterfaceUsuario() {
            if (!usuarioLogado) return;
            
            // Atualizar header
            document.getElementById('adminUserName').textContent = usuarioLogado.nome;
            document.getElementById('adminUnidadeNome').textContent = usuarioLogado.unidadeNome;
            
            // Atualizar informações do usuário
            const userSessionInfo = document.getElementById('userSessionInfo');
            const iniciais = usuarioLogado.nome.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            
            userSessionInfo.innerHTML = `
                <div class="user-avatar">${usuarioLogado.foto ? `<img src="${usuarioLogado.foto}" style="width:100%;height:100%;border-radius:50%;">` : iniciais}</div>
                <div style="text-align: right;">
                    <div style="font-weight: 600; color: white;">${usuarioLogado.nome}</div>
                    <div style="font-size: 11px; color: rgba(255,255,255,0.8);">${usuarioLogado.tipo === 'super_admin' ? 'Super Admin' : usuarioLogado.tipo === 'admin' ? 'Administrador' : 'Usuário'}</div>
                </div>
            `;
            
            // Configurar menus baseado no tipo de usuário
            configurarMenusPorTipoUsuario();
            
            // Mostrar botão de backup rápido se for matriz/admin
            if ((isMatriz && usuarioLogado.tipo === 'super_admin') || usuarioLogado.tipo === 'admin') {
                document.getElementById('botaoBackupRapido').style.display = 'flex';
                document.getElementById('botaoBackupRapido').innerHTML = '<i class="fas fa-database"></i>';
                document.getElementById('botaoBackupRapido').onclick = () => executarBackupCompleto('manual');
            }
        }

        // Configurar menus por tipo de usuário
        function configurarMenusPorTipoUsuario() {
            if (!usuarioLogado) return;
            
            // Resetar todos os menus especiais
            document.getElementById('menuSMS').style.display = 'none';
            document.getElementById('menuVideo').style.display = 'none';
            document.getElementById('menuUnidades').style.display = 'none';
            document.getElementById('menuUsuarios').style.display = 'none';
            document.getElementById('menuBackup').style.display = 'none';
            
            // Super Admin (GTI) tem acesso a tudo
            if (usuarioLogado.tipo === 'super_admin') {
                document.getElementById('menuSMS').style.display = 'block';
                document.getElementById('menuVideo').style.display = 'block';
                document.getElementById('menuUnidades').style.display = 'block';
                document.getElementById('menuUsuarios').style.display = 'block';
                document.getElementById('menuBackup').style.display = 'block';
            }
            // Admin pode gerenciar usuários de sua unidade
            else if (usuarioLogado.tipo === 'admin') {
                document.getElementById('menuSMS').style.display = 'block';
                document.getElementById('menuVideo').style.display = 'block';
                document.getElementById('menuUsuarios').style.display = 'block';
            }
            
            // Todos têm acesso a esses
            document.getElementById('menuFalto').style.display = 'block';
            document.getElementById('menuAtend').style.display = 'block';
        }

        // Logout
        function logout() {
            if (usuarioLogado) {
                registrarLogAcesso('logout');
            }
            
            usuarioLogado = null;
            localStorage.removeItem('userSession');
            auth.signOut();
            
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('botaoBackupRapido').style.display = 'none';
            mostrarNotificacao('Sessão encerrada', 'info');
        }

        // Registrar log de acesso
        function registrarLogAcesso(tipo = 'login') {
            if (!usuarioLogado) return;
            
            const logData = {
                email: usuarioLogado.email,
                tipo: tipo,
                data: new Date().toLocaleString('pt-BR'),
                unidadeId: unidadeID,
                unidadeNome: usuarioLogado.unidadeNome,
                userAgent: navigator.userAgent
            };
            
            db.ref(`logs_acesso/${Date.now()}`).set(logData);
        }

        // Mostrar notificação
        function mostrarNotificacao(mensagem, tipo = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.innerHTML = `
                <i class="fas ${tipo === 'success' ? 'fa-check-circle' : tipo === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                ${mensagem}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // ============================================
        // SISTEMA DE GERENCIAMENTO DE USUÁRIOS
        // ============================================

        // Mostrar seção de gerenciamento de usuários
        function mostrarSecaoUsuarios() {
            if (!usuarioLogado || (usuarioLogado.tipo !== 'super_admin' && usuarioLogado.tipo !== 'admin')) {
                mostrarMensagemAcessoRestrito('usuarios');
                return;
            }
            
            carregarPainelUsuarios();
        }

        // Carregar painel de usuários
        async function carregarPainelUsuarios() {
            const usuarios = await listarUsuariosAutorizados();
            
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="admin-section">
                    <h2><i class="fas fa-users-cog"></i> Gerenciamento de Usuários</h2>
                    <div class="section-info">
                        <i class="fas fa-info-circle"></i> 
                        ${usuarioLogado.tipo === 'super_admin' 
                            ? 'Como Super Admin, você pode criar administradores e usuários para qualquer unidade' 
                            : 'Como Administrador, você pode criar usuários para sua unidade'}
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 25px;">
                        <button class="admin-btn admin-btn-primary" onclick="abrirModalNovoUsuario()">
                            <i class="fas fa-user-plus"></i> Novo Usuário
                        </button>
                        <div style="color: #666;">
                            <i class="fas fa-users"></i> ${Object.keys(usuarios).length} usuários no sistema
                        </div>
                    </div>
                    
                    <!-- Tabela de usuários -->
                    <div style="overflow-x: auto; max-height: 500px;">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Email</th>
                                    <th>Tipo</th>
                                    <th>Unidade</th>
                                    <th>Status</th>
                                    <th>Último Acesso</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(usuarios).map(([emailKey, usuario]) => {
                                    const email = usuario.email || emailKey.replace(/_/g, '.');
                                    return `
                                        <tr>
                                            <td><strong>${usuario.nome || 'Sem nome'}</strong></td>
                                            <td>${email}</td>
                                            <td>
                                                <span class="status-badge ${usuario.tipo === 'super_admin' ? 'status-active' : usuario.tipo === 'admin' ? 'status-inactive' : ''}">
                                                    ${usuario.tipo === 'super_admin' ? 'SUPER ADMIN' : usuario.tipo === 'admin' ? 'ADMIN' : 'USUÁRIO'}
                                                </span>
                                            </td>
                                            <td>${usuario.unidadeNome || usuario.unidadeId || 'Matriz'}</td>
                                            <td>
                                                <span class="status-badge ${usuario.ativo ? 'status-active' : 'status-inactive'}">
                                                    ${usuario.ativo ? 'Ativo' : 'Inativo'}
                                                </span>
                                            </td>
                                            <td>${usuario.ultimoAcesso ? formatarDataRelativa(usuario.ultimoAcesso) : 'Nunca'}</td>
                                            <td>
                                                ${email !== 'gti@pmpf.rs.gov.br' ? `
                                                <button class="admin-btn" style="padding: 5px 10px; font-size: 12px;" 
                                                        onclick="editarUsuario('${emailKey}')" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="admin-btn ${usuario.ativo ? 'admin-btn-danger' : 'admin-btn-secondary'}" 
                                                        style="padding: 5px 10px; font-size: 12px;" 
                                                        onclick="${usuario.ativo ? `alterarStatusUsuario('${emailKey}', false)` : `alterarStatusUsuario('${emailKey}', true)`}"
                                                        title="${usuario.ativo ? 'Desativar' : 'Ativar'}">
                                                    <i class="fas ${usuario.ativo ? 'fa-ban' : 'fa-check'}"></i>
                                                </button>
                                                ${(usuarioLogado.tipo === 'super_admin' || (usuarioLogado.tipo === 'admin' && usuario.unidadeId === usuarioLogado.unidadeId)) ? `
                                                <button class="admin-btn admin-btn-danger" style="padding: 5px 10px; font-size: 12px;" 
                                                        onclick="removerUsuario('${emailKey}', '${email}')" title="Remover">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                                ` : ''}
                                                ` : '<small style="color:#999">Protegido</small>'}
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Listar usuários autorizados
        async function listarUsuariosAutorizados() {
            try {
                const snapshot = await db.ref('usuarios_autorizados').once('value');
                let usuarios = snapshot.val() || {};
                
                // Filtrar por unidade se for admin (não super_admin)
                if (usuarioLogado.tipo === 'admin') {
                    const filtered = {};
                    Object.entries(usuarios).forEach(([key, user]) => {
                        if (user.unidadeId === usuarioLogado.unidadeId || key === 'gti_pmpf_rs_gov_br') {
                            filtered[key] = user;
                        }
                    });
                    usuarios = filtered;
                }
                
                return usuarios;
            } catch (error) {
                console.error('[AUTH] Erro ao listar usuários:', error);
                return {};
            }
        }

        // Abrir modal para novo usuário
        function abrirModalNovoUsuario() {
            let unidadesOptions = '';
            
            if (usuarioLogado.tipo === 'super_admin') {
                // Super Admin pode ver todas unidades
                unidadesOptions = '<option value="geral">Matriz</option>';
                Object.entries(todasUnidades).forEach(([id, data]) => {
                    if (id !== 'geral') {
                        unidadesOptions += `<option value="${id}">${data.unidade?.nome || id}</option>`;
                    }
                });
            } else if (usuarioLogado.tipo === 'admin') {
                // Admin só pode ver sua unidade
                unidadesOptions = `<option value="${usuarioLogado.unidadeId}">${usuarioLogado.unidadeNome}</option>`;
            }
            
            const modalHTML = `
                <div class="modal-overlay" id="modalNovoUsuario" style="display: flex;">
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-user-plus"></i> Novo Usuário</h3>
                            <button class="modal-close" onclick="fecharModal('modalNovoUsuario')">&times;</button>
                        </div>
                        
                        <div class="form-group">
                            <label for="novoUsuarioNome">Nome Completo</label>
                            <input type="text" id="novoUsuarioNome" class="admin-input" 
                                   placeholder="Nome do usuário" autofocus>
                        </div>
                        
                        <div class="form-group">
                            <label for="novoUsuarioEmail">Email do Google</label>
                            <input type="email" id="novoUsuarioEmail" class="admin-input" 
                                   placeholder="usuario@gmail.com ou usuario@pmpf.rs.gov.br">
                            <small style="color: #666;">O usuário usará este email para fazer login</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="novoUsuarioTipo">Tipo de Usuário</label>
                            <select id="novoUsuarioTipo" class="admin-input">
                                <option value="usuario">Usuário Normal</option>
                                ${usuarioLogado.tipo === 'super_admin' ? '<option value="admin">Administrador</option>' : ''}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="novoUsuarioUnidade">Unidade de Saúde</label>
                            <select id="novoUsuarioUnidade" class="admin-input">
                                ${unidadesOptions}
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button class="admin-btn admin-btn-secondary" onclick="fecharModal('modalNovoUsuario')">Cancelar</button>
                            <button class="admin-btn admin-btn-primary" onclick="criarNovoUsuario()">
                                <i class="fas fa-check"></i> Criar Usuário
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Criar novo usuário
        async function criarNovoUsuario() {
            const nome = document.getElementById('novoUsuarioNome').value.trim();
            const email = document.getElementById('novoUsuarioEmail').value.trim();
            const tipo = document.getElementById('novoUsuarioTipo').value;
            const unidadeId = document.getElementById('novoUsuarioUnidade').value;
            
            // Validações
            if (!nome || !email) {
                mostrarNotificacao('Preencha todos os campos', 'error');
                return;
            }
            
            if (!email.includes('@')) {
                mostrarNotificacao('Email inválido', 'error');
                return;
            }
            
            // Verificar se email já está cadastrado
            const emailKey = email.replace(/[.#$/[\]]/g, '_');
            const snapshot = await db.ref(`usuarios_autorizados/${emailKey}`).once('value');
            if (snapshot.exists()) {
                mostrarNotificacao('Este email já está cadastrado', 'error');
                return;
            }
            
            // Obter nome da unidade
            let unidadeNome = 'Matriz';
            if (unidadeId !== 'geral' && todasUnidades[unidadeId]) {
                unidadeNome = todasUnidades[unidadeId].unidade?.nome || unidadeId;
            }
            
            // Criar usuário
            const usuarioData = {
                email: email,
                nome: nome,
                tipo: tipo,
                unidadeId: unidadeId,
                unidadeNome: unidadeNome,
                dataAutorizacao: new Date().toISOString(),
                ativo: true,
                criadoPor: usuarioLogado.email,
                podeCriarAdmins: (tipo === 'admin' && usuarioLogado.tipo === 'super_admin'),
                ultimoAcesso: null
            };
            
            // Salvar no Firebase
            await db.ref(`usuarios_autorizados/${emailKey}`).set(usuarioData);
            
            // Enviar email de convite
            enviarConviteUsuario(email, nome, unidadeNome, tipo);
            
            mostrarNotificacao(`Usuário ${nome} criado com sucesso!`, 'success');
            fecharModal('modalNovoUsuario');
            carregarPainelUsuarios();
        }

        // Enviar convite ao usuário
        function enviarConviteUsuario(email, nome, unidade, tipo) {
            const assunto = `Acesso Autorizado - Sistema de Saúde PMPF`;
            const mensagem = `
Olá ${nome},

Você foi cadastrado no Sistema de Saúde da Prefeitura Municipal de Passo Fundo.

Dados do seu acesso:
• Unidade: ${unidade}
• Tipo de acesso: ${tipo === 'admin' ? 'Administrador' : 'Usuário'}
• Email de login: ${email}

Para acessar:
1. Acesse: ${window.location.origin}${window.location.pathname}?id=${unidade === 'Matriz' ? 'geral' : 'unidade-id'}
2. Clique no ícone de engrenagem (canto superior direito)
3. Faça login com sua conta Google: ${email}

Este acesso é restrito à unidade ${unidade}.

Em caso de dúvidas, entre em contato com a GTI.

Atenciosamente,
Sistema de Saúde PMPF
            `;
            
            // Abrir cliente de email para envio
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(mensagem)}`;
            window.open(mailtoLink, '_blank');
            
            console.log(`[CONVITE] Convite enviado para: ${email}`);
        }

        // Editar usuário
        async function editarUsuario(emailKey) {
            const snapshot = await db.ref(`usuarios_autorizados/${emailKey}`).once('value');
            const usuario = snapshot.val();
            
            if (!usuario) return;
            
            let unidadesOptions = '';
            if (usuarioLogado.tipo === 'super_admin') {
                unidadesOptions = '<option value="geral">Matriz</option>';
                Object.entries(todasUnidades).forEach(([id, data]) => {
                    if (id !== 'geral') {
                        unidadesOptions += `<option value="${id}" ${id === usuario.unidadeId ? 'selected' : ''}>${data.unidade?.nome || id}</option>`;
                    }
                });
            } else {
                unidadesOptions = `<option value="${usuario.unidadeId}">${usuario.unidadeNome}</option>`;
            }
            
            const modalHTML = `
                <div class="modal-overlay" id="modalEditarUsuario" style="display: flex;">
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3><i class="fas fa-edit"></i> Editar Usuário</h3>
                            <button class="modal-close" onclick="fecharModal('modalEditarUsuario')">&times;</button>
                        </div>
                        
                        <div class="form-group">
                            <label>Email</label>
                            <input type="text" class="admin-input" value="${usuario.email}" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label for="editarUsuarioNome">Nome</label>
                            <input type="text" id="editarUsuarioNome" class="admin-input" 
                                   value="${usuario.nome || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label for="editarUsuarioTipo">Tipo</label>
                            <select id="editarUsuarioTipo" class="admin-input" ${usuario.email === 'gti@pmpf.rs.gov.br' ? 'disabled' : ''}>
                                <option value="usuario" ${usuario.tipo === 'usuario' ? 'selected' : ''}>Usuário</option>
                                ${usuarioLogado.tipo === 'super_admin' ? `<option value="admin" ${usuario.tipo === 'admin' ? 'selected' : ''}>Administrador</option>` : ''}
                            </select>
                        </div>
                        
                        ${usuarioLogado.tipo === 'super_admin' ? `
                        <div class="form-group">
                            <label for="editarUsuarioUnidade">Unidade</label>
                            <select id="editarUsuarioUnidade" class="admin-input">
                                ${unidadesOptions}
                            </select>
                        </div>
                        ` : ''}
                        
                        <div class="form-actions">
                            <button class="admin-btn admin-btn-secondary" onclick="fecharModal('modalEditarUsuario')">Cancelar</button>
                            <button class="admin-btn admin-btn-primary" onclick="salvarEdicaoUsuario('${emailKey}')">
                                <i class="fas fa-save"></i> Salvar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        // Salvar edição do usuário
        async function salvarEdicaoUsuario(emailKey) {
            const nome = document.getElementById('editarUsuarioNome').value;
            const tipo = document.getElementById('editarUsuarioTipo').value;
            const unidadeId = usuarioLogado.tipo === 'super_admin' ? document.getElementById('editarUsuarioUnidade').value : null;
            
            const atualizacoes = {
                nome: nome,
                tipo: tipo
            };
            
            if (unidadeId) {
                atualizacoes.unidadeId = unidadeId;
                if (todasUnidades[unidadeId]) {
                    atualizacoes.unidadeNome = todasUnidades[unidadeId].unidade?.nome || unidadeId;
                }
            }
            
            await db.ref(`usuarios_autorizados/${emailKey}`).update(atualizacoes);
            
            mostrarNotificacao('Usuário atualizado com sucesso!', 'success');
            fecharModal('modalEditarUsuario');
            carregarPainelUsuarios();
        }

        // Alterar status do usuário
        async function alterarStatusUsuario(emailKey, ativo) {
            await db.ref(`usuarios_autorizados/${emailKey}/ativo`).set(ativo);
            
            mostrarNotificacao(`Usuário ${ativo ? 'ativado' : 'desativado'} com sucesso!`, 'success');
            carregarPainelUsuarios();
        }

        // Remover usuário
        async function removerUsuario(emailKey, email) {
            if (!confirm(`Tem certeza que deseja remover o usuário ${email}?`)) return;
            
            await db.ref(`usuarios_autorizados/${emailKey}`).remove();
            
            mostrarNotificacao(`Usuário ${email} removido com sucesso!`, 'success');
            carregarPainelUsuarios();
        }

        // Fechar modal
        function fecharModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
        }

        // Formatador de data relativa
        function formatarDataRelativa(dataISO) {
            if (!dataISO) return 'Nunca';
            
            try {
                const data = new Date(dataISO);
                const agora = new Date();
                const diffMs = agora - data;
                const diffMin = Math.floor(diffMs / 60000);
                const diffHoras = Math.floor(diffMin / 60);
                const diffDias = Math.floor(diffHoras / 24);
                
                if (diffDias > 0) return `Há ${diffDias} dia${diffDias > 1 ? 's' : ''}`;
                if (diffHoras > 0) return `Há ${diffHoras} hora${diffHoras > 1 ? 's' : ''}`;
                if (diffMin > 0) return `Há ${diffMin} minuto${diffMin > 1 ? 's' : ''}`;
                return 'Agora mesmo';
            } catch (e) {
                return dataISO;
            }
        }

        // ============================================
        // SISTEMA DE BACKUP AUTOMÁTICO
        // ============================================

        let backupInterval = null;
        let ultimoBackup = null;
        let statusBackup = {};

        // Inicializar sistema de backup
        function inicializarSistemaBackup() {
            // Carregar status do backup
            carregarStatusBackup();
            
            // Verificar backup automático (sexta-feira 00:00)
            verificarBackupAutomatico();
            
            // Verificar periodicamente (a cada hora)
            setInterval(verificarBackupAutomatico, 60 * 60 * 1000);
            
            // Verificar a cada minuto para precisão
            setInterval(() => {
                const agora = new Date();
                if (agora.getHours() === 0 && agora.getMinutes() === 0) {
                    verificarBackupAutomatico();
                }
            }, 60 * 1000);
        }

        // Carregar status do backup
        async function carregarStatusBackup() {
            try {
                const snapshot = await db.ref('backup/status').once('value');
                statusBackup = snapshot.val() || {};
                ultimoBackup = statusBackup.ultimoBackup;
            } catch (error) {
                console.error('[BACKUP] Erro ao carregar status:', error);
            }
        }

        // Verificar backup automático
        function verificarBackupAutomatico() {
            const agora = new Date();
            const diaDaSemana = agora.getDay(); // 0=Domingo, 5=Sexta
            const hora = agora.getHours();
            const minuto = agora.getMinutes();
            
            // Verificar se é sexta-feira (5) às 00:00
            if (diaDaSemana === 5 && hora === 0 && minuto === 0) {
                console.log('[BACKUP] Iniciando backup automático (sexta-feira 00:00)');
                executarBackupCompleto('automático');
            }
        }

        // Executar backup completo
        async function executarBackupCompleto(tipo = 'manual') {
            if (!usuarioLogado || (usuarioLogado.tipo !== 'super_admin' && usuarioLogado.tipo !== 'admin')) {
                mostrarNotificacao('Apenas administradores podem executar backups', 'error');
                return;
            }
            
            try {
                mostrarNotificacao('Iniciando backup do sistema...', 'info');
                
                // Coletar dados
                const dadosParaBackup = await coletarDadosParaBackup();
                
                // Gerar nome do backup
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const nomeBackup = `backup_${tipo}_${timestamp}`;
                
                // Salvar backup
                await db.ref(`backup/arquivos/${nomeBackup}`).set({
                    dados: dadosParaBackup,
                    tipo: tipo,
                    data: new Date().toISOString(),
                    executadoPor: usuarioLogado.email,
                    tamanho: JSON.stringify(dadosParaBackup).length
                });
                
                // Atualizar status
                const dataBackup = new Date().toLocaleString('pt-BR');
                await db.ref('backup/status').set({
                    ultimoBackup: dataBackup,
                    tipoUltimoBackup: tipo,
                    executadoPor: usuarioLogado.email,
                    totalBackups: (statusBackup.totalBackups || 0) + 1
                });
                
                // Atualizar localmente
                ultimoBackup = dataBackup;
                statusBackup.ultimoBackup = dataBackup;
                statusBackup.totalBackups = (statusBackup.totalBackups || 0) + 1;
                
                mostrarNotificacao(`Backup ${tipo} realizado com sucesso!`, 'success');
                registrarLogBackup(tipo, nomeBackup, 'sucesso');
                
                // Atualizar interface se estiver na seção de backup
                if (document.getElementById('adminContent').innerHTML.includes('backup')) {
                    mostrarPainelBackup();
                }
                
            } catch (error) {
                console.error('[BACKUP] Erro:', error);
                mostrarNotificacao('Erro ao fazer backup: ' + error.message, 'error');
                registrarLogBackup(tipo, null, 'erro', error.message);
            }
        }

        // Coletar dados para backup
        async function coletarDadosParaBackup() {
            console.log('[BACKUP] Coletando dados...');
            
            const snapshotPaineis = await db.ref('paineis').once('value');
            const snapshotUsuarios = await db.ref('usuarios_autorizados').once('value');
            const snapshotLogs = await db.ref('logs_acesso').limitToLast(1000).once('value');
            
            return {
                metadados: {
                    dataBackup: new Date().toISOString(),
                    versao: '2.0',
                    totalUnidades: Object.keys((snapshotPaineis.val() || {})).length,
                    totalUsuarios: Object.keys((snapshotUsuarios.val() || {})).length
                },
                paineis: snapshotPaineis.val() || {},
                usuarios_autorizados: snapshotUsuarios.val() || {},
                logs_acesso: snapshotLogs.val() || {},
                status_sistema: {
                    ultimoBackup: ultimoBackup,
                    totalBackups: statusBackup.totalBackups || 0
                }
            };
        }

        // Registrar log do backup
        function registrarLogBackup(tipo, nomeArquivo, status, erro = null) {
            const logData = {
                tipo: tipo,
                nomeArquivo: nomeArquivo,
                status: status,
                data: new Date().toLocaleString('pt-BR'),
                executadoPor: usuarioLogado ? usuarioLogado.email : 'sistema',
                erro: erro
            };
            
            db.ref(`logs_backup/${Date.now()}`).set(logData);
        }

        // Mostrar painel de backup
        async function mostrarPainelBackup() {
            if (!usuarioLogado || (usuarioLogado.tipo !== 'super_admin' && usuarioLogado.tipo !== 'admin')) {
                mostrarMensagemAcessoRestrito('backup');
                return;
            }
            
            const backups = await listarBackupsRecentes();
            
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="admin-section">
                    <h2><i class="fas fa-database"></i> Sistema de Backup</h2>
                    
                    <div class="section-info">
                        <i class="fas fa-info-circle"></i> Backups automáticos toda <strong>sexta-feira às 00:00</strong>
                    </div>
                    
                    <div class="status-monitor">
                        <div class="status-card" style="border-color: #4caf50;">
                            <h3>Último Backup</h3>
                            <div class="status-count" style="color: #4caf50;">
                                ${ultimoBackup ? formatarDataRelativa(ultimoBackup) : 'Nunca'}
                            </div>
                            <div class="status-desc">
                                ${ultimoBackup || 'Nenhum backup'}
                            </div>
                        </div>
                        
                        <div class="status-card" style="border-color: #2196f3;">
                            <h3>Próximo Backup</h3>
                            <div class="status-count" style="color: #2196f3;">
                                ${calcularProximoBackup()}
                            </div>
                            <div class="status-desc">
                                Sexta-feira 00:00
                            </div>
                        </div>
                        
                        <div class="status-card" style="border-color: #ff9800;">
                            <h3>Total</h3>
                            <div class="status-count" style="color: #ff9800;">
                                ${statusBackup.totalBackups || 0}
                            </div>
                            <div class="status-desc">
                                Backups realizados
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 30px 0;">
                        <button class="admin-btn admin-btn-primary" onclick="executarBackupCompleto('manual')" style="padding: 15px 40px; font-size: 16px;">
                            <i class="fas fa-play-circle"></i> Executar Backup Manual
                        </button>
                    </div>
                    
                    <div style="margin-top: 40px;">
                        <h3><i class="fas fa-history"></i> Backups Recentes</h3>
                        ${backups}
                    </div>
                </div>
            `;
        }

        // Listar backups recentes
        async function listarBackupsRecentes() {
            try {
                const snapshot = await db.ref('backup/arquivos').orderByKey().limitToLast(5).once('value');
                const backups = snapshot.val() || {};
                
                if (Object.keys(backups).length === 0) {
                    return '<p style="color: #666; text-align: center; padding: 30px;">Nenhum backup encontrado</p>';
                }
                
                const backupsArray = Object.entries(backups).map(([nome, dados]) => ({
                    nome,
                    ...dados
                })).sort((a, b) => new Date(b.data) - new Date(a.data));
                
                return `
                    <div style="overflow-x: auto; margin-top: 20px;">
                        <table class="log-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Tamanho</th>
                                    <th>Executado por</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${backupsArray.map(backup => `
                                    <tr>
                                        <td>${new Date(backup.data).toLocaleString('pt-BR')}</td>
                                        <td>
                                            <span class="status-badge ${backup.tipo === 'automático' ? 'status-active' : 'status-inactive'}">
                                                ${backup.tipo}
                                            </span>
                                        </td>
                                        <td>${formatarTamanho(backup.tamanho || 0)}</td>
                                        <td>${backup.executadoPor}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                return '<p style="color: #d32f2f; text-align: center;">Erro ao carregar backups</p>';
            }
        }

        // Calcular próximo backup
        function calcularProximoBackup() {
            const agora = new Date();
            const diaDaSemana = agora.getDay();
            const diasParaSexta = diaDaSemana <= 5 ? 5 - diaDaSemana : 5 + (7 - diaDaSemana);
            
            const proximaSexta = new Date(agora);
            proximaSexta.setDate(agora.getDate() + diasParaSexta);
            proximaSexta.setHours(0, 0, 0, 0);
            
            if (diaDaSemana === 5 && agora.getHours() < 0) {
                return "Hoje 00:00";
            }
            
            if (diaDaSemana === 5) {
                proximaSexta.setDate(proximaSexta.getDate() + 7);
            }
            
            const diffMs = proximaSexta - agora;
            const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDias === 0) return "Hoje 00:00";
            if (diffDias === 1) return "Amanhã 00:00";
            return `Em ${diffDias} dias`;
        }

        // Formatar tamanho
        function formatarTamanho(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ============================================
        // FUNÇÕES ORIGINAIS DO SISTEMA
        // ============================================

        function openLogin() {
            if (usuarioLogado) {
                document.getElementById('adminPanel').style.display = 'flex';
                mostrarSecao('unidade');
                return;
            }
            
            mostrarTelaLoginGoogle();
        }

        function mostrarMensagemAcessoRestrito(secao) {
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="admin-section">
                    <h2><i class="fas fa-lock"></i> Acesso Restrito</h2>
                    <div class="section-info">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Você não tem permissão para acessar esta seção.
                    </div>
                    <p style="color: #666; text-align: center; padding: 40px;">
                        Apenas administradores podem acessar a seção de ${secao}.
                    </p>
                </div>
            `;
        }

        function mostrarSecao(secao) {
            const content = document.getElementById('adminContent');
            document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
            
            let activeElement = document.querySelector(`.sidebar-item[onclick*="${secao}"]`);
            if (activeElement) activeElement.classList.add('active');
            
            // Seções especiais
            if (secao === 'usuarios') {
                mostrarSecaoUsuarios();
                return;
            }
            
            if (secao === 'backup') {
                mostrarPainelBackup();
                return;
            }
            
            // Resto das funções originais...
            const secaoMatriz = ['sms', 'video', 'unidades', 'monitor'];
            
            if (secaoMatriz.includes(secao) && (!usuarioLogado || usuarioLogado.tipo !== 'super_admin')) {
                mostrarMensagemAcessoRestrito(secao);
                return;
            }
            
            // [MANTENHA O RESTO DAS FUNÇÕES ORIGINAIS AQUI]
            // As funções originais do sistema continuam funcionando
        }

        // Funções originais (resumidas para espaço)
        function carregarDadosFirebase() {
            db.ref('paineis/' + unidadeID).on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    dadosUnidade = data;
                    document.getElementById('headerSubtitle').textContent = `PMPF - ${dadosUnidade.unidade.nome || 'Matriz'}`;
                    if (usuarioLogado) {
                        document.getElementById('adminUnidadeNome').textContent = dadosUnidade.unidade.nome || unidadeID;
                    }
                    processarInterface();
                }
            });
            
            db.ref('paineis/geral').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) { 
                    dadosGerais = data; 
                    processarInterface(); 
                }
            });
            
            if (isMatriz) {
                db.ref('paineis').on('value', (snapshot) => {
                    todasUnidades = snapshot.val() || {};
                });
            }
        }

        function processarInterface() { 
            atualizarInterface(); 
            carregarVideo(); 
            iniciarAvisos(); 
        }

        function atualizarRelogio() {
            const agora = new Date();
            document.getElementById('currentDate').textContent = agora.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });
            document.getElementById('currentTime').textContent = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function carregarVideo() {
            const container = document.getElementById('videoContainer');
            const videoUrls = dadosGerais.unidade.videoUrls || [];
            const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
            const ids = videoUrls.map(url => { const m = url.match(regExp); return (m && m[7].length === 11) ? m[7] : null; }).filter(id => id !== null);
            if (ids.length > 0) {
                const src = `https://www.youtube.com/embed/${ids[0]}?autoplay=1&mute=${isMuted ? 1 : 0}&loop=1&playlist=${ids.join(',')}&controls=0`;
                if (!container.innerHTML.includes(ids[0]) || (isMuted === false && container.innerHTML.includes('mute=1'))) {
                    container.innerHTML = `<iframe class="video-iframe" src="${src}" allow="autoplay; encrypted-media"></iframe>`;
                }
            }
        }

        function ativarSom() { 
            isMuted = false; 
            carregarVideo(); 
            document.getElementById('btnSom').style.display = 'none'; 
        }

        function atualizarInterface() {
            renderBloco('itemFaltometro', 'FALTÔMETRO - Falta dos pacientes às consultas', 'Total mês anterior', dadosUnidade.unidade.especialidades, 'faltas', '#ff5252', '');
            renderBloco('itemAtendimentos', '<span style="color:white">ATENDIMENTOS NESTA UNIDADE</span>', '<span style="color:white">Total mês anterior</span>', dadosUnidade.unidade.atendimentos, 'valor', '#2196f3', 'atendimentos-title total-atendimentos');
            renderBloco('itemSMS', '<span style="color:white">ATENDIMENTOS NAS UNIDADES DE SAÚDE </span>', '<span style="color:white">Total mês anterior</span>', dadosGerais.unidade.smsMunicipal, 'valor', '#ba68c8', 'sms-title total-sms');
        }

        function renderBloco(id, titulo, label, lista, chave, cor, classe) {
            const itens = lista || [];
            const total = itens.reduce((a, b) => a + (parseInt(b[chave]) || 0), 0);
            document.getElementById(id).innerHTML = `<h2 class="section-title ${classe}">${titulo}</h2><div class="total-container ${classe}"><div style="font-size: 16px; opacity:0.9">${label}</div><div class="total-value" style="color:white">${total}</div></div><div class="lista-container">${itens.map(e => `<div class="item-lista"><span class="item-nome">${e.nome}</span><span class="item-valor" style="color:${cor}">${e[chave]}</span></div>`).join('')}</div>`;
        }

        function iniciarAnimacaoCarrossel() {
            const slides = document.querySelectorAll('.carousel-item');
            setInterval(() => {
                slides.forEach(s => s.classList.remove('active'));
                carouselIndex = (carouselIndex + 1) % slides.length;
                if (slides[carouselIndex]) slides[carouselIndex].classList.add('active');
            }, 60000); 
        }

        function iniciarAvisos() {
            const container = document.getElementById('tickerContainer');
            const avisos = [...(dadosGerais.avisos || []), ...(dadosUnidade.avisos || [])].filter(a => a && a.trim() !== '');
            if (tickerInterval) clearInterval(tickerInterval);
            if (avisos.length === 0) { container.innerHTML = ''; return; }
            container.innerHTML = avisos.map(a => `<div class="ticker-item">${a}</div>`).join('');
            const items = container.querySelectorAll('.ticker-item');
            let idx = 0;
            const mostrarProximo = () => {
                items.forEach(i => { i.classList.remove('active'); i.style.opacity = "0"; });
                if (items.length === 1) { items[0].style.opacity = "1"; items[0].style.transform = "translateX(0)"; return; }
                if (items[idx]) items[idx].classList.add('active');
                idx = (idx + 1) % items.length;
            };
            mostrarProximo();
            if (items.length > 1) tickerInterval = setInterval(mostrarProximo, 30000);
        }

        function salvarDados(isLocalUpdate = false, tipoAlteracao = null) { 
            db.ref('paineis/' + unidadeID).set(dadosUnidade); 
            if (isMatriz) db.ref('paineis/geral').set(dadosGerais);
            
            if (isLocalUpdate && tipoAlteracao) {
                // salvarLogDetalhado(tipoAlteracao); // Função original
            }
            mostrarNotificacao('Dados salvos com sucesso!', 'success');
        }

        // ============================================
        // INICIALIZAÇÃO
        // ============================================

        window.onload = async () => { 
            // Inicializar sistema de autenticação
            await inicializarSistemaAutenticacao();
            
            // Inicializar sistema de backup
            inicializarSistemaBackup();
            
            // Carregar dados do Firebase
            carregarDadosFirebase(); 
            
            // Configurar relógio
            atualizarRelogio(); 
            setInterval(atualizarRelogio, 1000); 
            
            // Iniciar animações
            iniciarAnimacaoCarrossel(); 
        };
    </script>
</body>
</html>
