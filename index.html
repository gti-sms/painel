<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1920, height=1080, initial-scale=1.0">
    <title>Sistema de Saúde - Passo Fundo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background: #0a0e27; color: white; width: 1920px; height: 1080px; overflow: hidden; position: fixed; }

        /* Header Otimizado */
        .main-header { background: rgba(21, 101, 192, 0.9); padding: 0 40px; display: flex; align-items: center; justify-content: space-between; border-bottom: 3px solid #00e676; height: 85px; width: 100%; z-index: 100; }
        .header-text h1 { font-size: 32px; font-weight: 800; }
        .header-time { font-size: 48px; font-weight: 900; color: #00e676; font-family: monospace; }

        /* Container Principal */
        .main-container { display: grid; grid-template-columns: 72% 28%; gap: 15px; padding: 15px; height: calc(1080px - 85px); }
        .left-column { display: flex; flex-direction: column; gap: 12px; height: 100%; }
        
        /* Seção de Vídeo */
        .video-section { background: #000; border-radius: 15px; overflow: hidden; flex: 1; position: relative; border: 2px solid rgba(0, 230, 118, 0.3); }
        .video-iframe { width: 100%; height: 100%; border: none; }
        .btn-som { position: absolute; bottom: 20px; left: 20px; z-index: 101; background: #00e676; color: #000; border: none; padding: 12px 25px; border-radius: 50px; cursor: pointer; font-weight: 800; font-size: 18px; }

        /* Coluna Lateral - Itens em Lista Única */
        .right-column { background: rgba(13, 27, 42, 0.8); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); position: relative; overflow: hidden; }
        .carousel-item { position: absolute; width: calc(100% - 40px); height: calc(100% - 40px); opacity: 0; display: none; transition: opacity 0.8s ease-in-out; }
        .carousel-item.active { opacity: 1; display: flex; flex-direction: column; }

        .section-title { font-size: 32px; color: #00e676; text-align: center; margin-bottom: 10px; font-weight: 800; text-transform: uppercase; }
        .total-box { background: rgba(255, 0, 0, 0.2); padding: 10px; border-radius: 12px; text-align: center; margin-bottom: 15px; border: 1px solid rgba(255,0,0,0.3); }
        .total-box span { font-size: 18px; color: #eee; }
        .total-box h4 { font-size: 50px; line-height: 1; color: #fff; }

        .lista-container { flex: 1; display: flex; flex-direction: column; gap: 6px; overflow: hidden; }
        .item-lista { background: rgba(255, 255, 255, 0.07); padding: 10px 18px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        .item-nome { font-size: 22px; font-weight: 600; color: #fff; }
        .item-valor { font-size: 32px; font-weight: 900; color: #00e676; font-family: monospace; }

        /* Ticker de Avisos Corrigido */
        .announcements-section { background: rgba(33, 150, 243, 0.15); border-radius: 15px; height: 110px; border: 2px solid rgba(33, 150, 243, 0.4); position: relative; overflow: hidden; }
        .ticker-wrapper { width: 100%; height: 100%; position: relative; }
        .ticker-item { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: 700; text-align: center; color: #fff; padding: 0 50px; opacity: 0; transform: translateY(30px); transition: all 0.6s ease-in-out; }
        .ticker-item.active { opacity: 1; transform: translateY(0); }

        /* Admin */
        #loginScreen, #adminPanel { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; }
        .admin-content { padding: 30px; overflow-y: auto; color: #333; background: #f4f4f4; height: 100%; }
        .admin-input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        .admin-btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: 700; color: white; background: #00e676; }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="header-left">
            <h1 id="unidadeTitulo">Carregando...</h1>
            <p id="headerSubtitle" style="color:#00e676">Secretaria Municipal de Saúde - Passo Fundo</p>
        </div>
        <div id="currentTime" class="header-time">00:00</div>
    </header>

    <main class="main-container">
        <div class="left-column">
            <section class="video-section">
                <button id="btnSom" class="btn-som" onclick="ativarSom()"><i class="fas fa-volume-up"></i> ATIVAR SOM</button>
                <div id="videoContainer" style="width:100%; height:100%;"></div>
            </section>
            <section class="announcements-section">
                <div class="ticker-wrapper" id="tickerContainer"></div>
            </section>
        </div>

        <div class="right-column">
            <div class="carousel-item active" id="itemFaltometro"></div>
            <div class="carousel-item" id="itemAtendimentos"></div>
            <div class="carousel-item" id="itemSMS"></div>
        </div>
    </main>

    <div style="position:fixed; bottom:10px; right:10px; opacity:0.1; cursor:pointer; z-index:1000;" onclick="openLogin()"><i class="fas fa-cog"></i></div>

    <div id="loginScreen" style="display:none; justify-content:center; align-items:center;">
        <div style="background:#fff; padding:40px; border-radius:15px; text-align:center;">
            <h2 style="color:#333; margin-bottom:20px;">Acesso Administrativo</h2>
            <input type="password" id="adminPass" class="admin-input" placeholder="Senha">
            <button class="admin-btn" style="width:100%; margin-top:10px;" onclick="login()">Entrar</button>
        </div>
    </div>

    <div id="adminPanel">
        <div style="background:#1565c0; color:white; padding:15px 40px; display:flex; justify-content:space-between; align-items:center;">
            <h2>Painel de Controle</h2>
            <button class="admin-btn" style="background:#f44336" onclick="logout()">Salvar e Sair</button>
        </div>
        <div style="display:grid; grid-template-columns:250px 1fr; height:calc(100% - 70px);">
            <div style="background:#fff; border-right:1px solid #ddd;">
                <div class="sidebar-item" onclick="mostrarSecao('unidade')" style="padding:15px; cursor:pointer; border-bottom:1px solid #eee; color:#333;">Unidade</div>
                <div class="sidebar-item" onclick="mostrarSecao('faltometro')" style="padding:15px; cursor:pointer; border-bottom:1px solid #eee; color:#333;">Faltômetro</div>
                <div class="sidebar-item" onclick="mostrarSecao('atendimentos')" style="padding:15px; cursor:pointer; border-bottom:1px solid #eee; color:#333;">Atendimentos</div>
                <div class="sidebar-item" onclick="mostrarSecao('sms')" style="padding:15px; cursor:pointer; border-bottom:1px solid #eee; color:#333;">Produção Municipal</div>
                <div class="sidebar-item" onclick="mostrarSecao('avisos')" style="padding:15px; cursor:pointer; border-bottom:1px solid #eee; color:#333;">Avisos</div>
                <div class="sidebar-item" onclick="mostrarSecao('video')" style="padding:15px; cursor:pointer; border-bottom:1px solid #eee; color:#333;">Vídeos</div>
            </div>
            <div class="admin-content" id="adminContent"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCEyebuGCoD8NYQJrIR1KpRRpkWijveN3A",
            authDomain: "gti-painel.firebaseapp.com",
            projectId: "gti-painel",
            databaseURL: "https://gti-painel-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const unidadeID = new URLSearchParams(window.location.search).get('id') || 'geral';

        let dadosSistema = {
            unidade: { nome: "Unidade de Saúde", videoUrls: [], especialidades: [], atendimentos: [], smsMunicipal: [] },
            avisos: []
        };

        let cIdx = 0;
        let tIdx = 0;
        let isMuted = true;

        function carregarDados() {
            db.ref('paineis/' + unidadeID).on('value', (snapshot) => {
                if (snapshot.val()) {
                    dadosSistema = snapshot.val();
                    document.getElementById('unidadeTitulo').innerText = dadosSistema.unidade.nome;
                    renderizarInterfacePublica();
                }
            });
        }

        function renderizarInterfacePublica() {
            // Render Faltometro (Máx 15 itens)
            const fList = (dadosSistema.unidade.especialidades || []).slice(0, 15);
            const fTotal = fList.reduce((a, b) => a + (parseInt(b.faltas) || 0), 0);
            document.getElementById('itemFaltometro').innerHTML = `
                <h2 class="section-title">Faltômetro</h2>
                <div class="total-box"><span>Total de Faltas</span><h4>${fTotal}</h4></div>
                <div class="lista-container">${fList.map(e => `
                    <div class="item-lista"><span class="item-nome">${e.nome}</span><span class="item-valor" style="color:#ff5252">${e.faltas}</span></div>
                `).join('')}</div>`;

            // Atendimentos
            const aList = (dadosSistema.unidade.atendimentos || []).slice(0, 15);
            const aTotal = aList.reduce((a, b) => a + (parseInt(b.valor) || 0), 0);
            document.getElementById('itemAtendimentos').innerHTML = `
                <h2 class="section-title" style="color:#2196f3">Atendimentos</h2>
                <div class="total-box" style="background:rgba(33,150,243,0.2); border-color:rgba(33,150,243,0.4)"><span>Em Atendimento</span><h4>${aTotal}</h4></div>
                <div class="lista-container">${aList.map(e => `
                    <div class="item-lista"><span class="item-nome">${e.nome}</span><span class="item-valor" style="color:#2196f3">${e.valor}</span></div>
                `).join('')}</div>`;

            // Produção
            const pList = (dadosSistema.unidade.smsMunicipal || []).slice(0, 15);
            const pTotal = pList.reduce((a, b) => a + (parseInt(b.valor) || 0), 0);
            document.getElementById('itemSMS').innerHTML = `
                <h2 class="section-title" style="color:#ba68c8">Produção Municipal</h2>
                <div class="total-box" style="background:rgba(186,104,200,0.2); border-color:rgba(186,104,200,0.4)"><span>Total Geral</span><h4>${pTotal}</h4></div>
                <div class="lista-container">${pList.map(e => `
                    <div class="item-lista"><span class="item-nome">${e.nome}</span><span class="item-valor" style="color:#ba68c8">${e.valor}</span></div>
                `).join('')}</div>`;

            // Avisos
            const ticker = document.getElementById('tickerContainer');
            ticker.innerHTML = (dadosSistema.avisos || []).map(a => `<div class="ticker-item">${a}</div>`).join('');
            iniciarTicker();
            carregarVideo();
        }

        function carregarVideo() {
            const ids = (dadosSistema.unidade.videoUrls || []).map(url => {
                const match = url.match(/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/);
                return (match && match[7].length === 11) ? match[7] : null;
            }).filter(id => id);
            if(ids.length > 0) {
                const src = `https://www.youtube.com/embed/${ids[0]}?enablejsapi=1&autoplay=1&mute=${isMuted?1:0}&loop=1&playlist=${ids.join(',')}&controls=0`;
                const container = document.getElementById('videoContainer');
                if (!container.innerHTML.includes(ids[0])) container.innerHTML = `<iframe id="ytPlayer" class="video-iframe" src="${src}" allow="autoplay; encrypted-media"></iframe>`;
            }
        }

        function ativarSom() { 
            isMuted = false; 
            const player = document.getElementById('ytPlayer');
            if(player) player.src = player.src.replace("mute=1", "mute=0");
            document.getElementById('btnSom').style.display='none'; 
        }

        function iniciarTicker() {
            const items = document.querySelectorAll('.ticker-item');
            if(items.length === 0) return;
            items.forEach(i => i.classList.remove('active'));
            tIdx = 0;
            items[0].classList.add('active');
        }

        // Loop dos Avisos (Ticker)
        setInterval(() => {
            const items = document.querySelectorAll('.ticker-item');
            if(items.length > 1) {
                items[tIdx].classList.remove('active');
                tIdx = (tIdx + 1) % items.length;
                items[tIdx].classList.add('active');
            }
        }, 10000);

        // Loop do Carrossel Lateral
        setInterval(() => {
            const slides = document.querySelectorAll('.carousel-item');
            if(slides.length > 1) {
                slides[cIdx].classList.remove('active');
                setTimeout(() => {
                    slides[cIdx].style.display = 'none';
                    cIdx = (cIdx + 1) % slides.length;
                    slides[cIdx].style.display = 'flex';
                    setTimeout(() => slides[cIdx].classList.add('active'), 50);
                }, 800);
            }
        }, 20000);

        setInterval(() => {
            document.getElementById('currentTime').innerText = new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
        }, 1000);

        function openLogin() { document.getElementById('loginScreen').style.display='flex'; }
        function login() { if(document.getElementById('adminPass').value === 'smspmpf2026') { document.getElementById('loginScreen').style.display='none'; document.getElementById('adminPanel').style.display='flex'; mostrarSecao('unidade'); } }
        function logout() { db.ref('paineis/' + unidadeID).set(dadosSistema).then(() => location.reload()); }

        function mostrarSecao(secao) {
            const content = document.getElementById('adminContent');
            if(secao === 'unidade') {
                content.innerHTML = `<h3>Nome da Unidade</h3><input class="admin-input" value="${dadosSistema.unidade.nome}" onchange="dadosSistema.unidade.nome=this.value">`;
            } else if(['faltometro','atendimentos','sms'].includes(secao)) {
                const map = {faltometro:['especialidades','faltas'], atendimentos:['atendimentos','valor'], sms:['smsMunicipal','valor']};
                renderListaAdmin(content, map[secao][0], map[secao][1], secao);
            } else if(secao === 'avisos') {
                content.innerHTML = `<h3>Avisos (Um por linha)</h3><textarea class="admin-input" style="height:200px" onchange="dadosSistema.avisos=this.value.split('\\n')">${(dadosSistema.avisos || []).join('\n')}</textarea>`;
            } else if(secao === 'video') {
                content.innerHTML = `<h3>Vídeos YouTube (Links)</h3><textarea class="admin-input" style="height:200px" onchange="dadosSistema.unidade.videoUrls=this.value.split('\\n')">${(dadosSistema.unidade.videoUrls || []).join('\n')}</textarea>`;
            }
        }

        function renderListaAdmin(container, chave, campoValor, secao) {
            const lista = dadosSistema.unidade[chave] || [];
            container.innerHTML = `<h3>Configurar ${secao}</h3>` + lista.map((item, i) => `
                <div style="display:flex; gap:10px; margin-bottom:5px;">
                    <input class="admin-input" style="flex:2" value="${item.nome}" onchange="dadosSistema.unidade.${chave}[${i}].nome=this.value">
                    <input class="admin-input" style="flex:1" type="number" value="${item[campoValor]}" onchange="dadosSistema.unidade.${chave}[${i}].${campoValor}=this.value">
                    <button class="admin-btn" style="background:red" onclick="dadosSistema.unidade.${chave}.splice(${i},1); mostrarSecao('${secao}')">X</button>
                </div>`).join('') + `<button class="admin-btn" style="width:100%; margin-top:10px" onclick="dadosSistema.unidade.${chave}.push({nome:'', ${campoValor}:0}); mostrarSecao('${secao}')">+ Adicionar</button>`;
        }

        window.onload = carregarDados;
    </script>
</body>
</html>
